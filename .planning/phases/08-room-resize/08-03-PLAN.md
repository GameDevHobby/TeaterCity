---
phase: 08-room-resize
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/room_editing/RoomResizeHighlight.gd
autonomous: true

must_haves:
  truths:
    - "Preview box renders with green fill/border when validation passes"
    - "Preview box renders with red fill/border when validation fails"
    - "Blocked furniture tiles are highlighted in orange when validation fails"
    - "Highlight updates in real-time during drag via signal connection"
  artifacts:
    - path: "scripts/room_editing/RoomResizeHighlight.gd"
      provides: "Visual rendering for resize preview"
      exports: ["RoomResizeHighlight"]
  key_links:
    - from: "scripts/room_editing/RoomResizeHighlight.gd"
      to: "scripts/room_editing/RoomResizeController.gd"
      via: "preview_updated signal connection"
      pattern: "_controller\\.preview_updated\\.connect"
    - from: "scripts/room_editing/RoomResizeHighlight.gd"
      to: "scripts/room_building/ui/RoomBuildDrawing.gd"
      via: "tile highlight rendering"
      pattern: "RoomBuildDrawing\\.draw_tile_highlight"
---

<objective>
Create RoomResizeHighlight class for rendering resize preview visuals.

Purpose: During resize drag, users need visual feedback showing the new bounds and whether the resize is valid. Green preview = valid resize, Red preview = invalid (with orange highlights on blocked furniture). This follows the established pattern of *Highlight classes that connect to *Controller signals.

Output: `scripts/room_editing/RoomResizeHighlight.gd` with preview box rendering and blocked furniture highlighting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-room-resize/08-RESEARCH.md

Key existing files to reference:
- scripts/room_building/RoomBuildUI.gd lines 184-244 - _draw_box_selection() for box preview rendering
- scripts/room_building/ui/RoomBuildDrawing.gd - draw_tile_highlight static helper
- scripts/room_editing/FurnitureSelectionHighlight.gd - controller-to-highlight signal pattern
- scripts/room_editing/DoorEditHighlight.gd - highlight rendering pattern
- scripts/utils/IsometricMath.gd - tile_to_screen for coordinate conversion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoomResizeHighlight with preview rendering</name>
  <files>scripts/room_editing/RoomResizeHighlight.gd</files>
  <action>
Create a new Control class following the DoorEditHighlight pattern.

**Class structure:**

```gdscript
class_name RoomResizeHighlight
extends Control

## Visual highlight for room resize preview.
## Renders box preview during drag with valid/invalid coloring.
## Follows DoorEditHighlight pattern for controller signal connection.

# Colors (matching RoomBuildUI pattern)
const VALID_FILL := Color(0.2, 0.8, 0.4, 0.2)        # Light green fill
const VALID_BORDER := Color(0.2, 0.8, 0.4, 1.0)      # Green border
const VALID_WALL := Color(0.2, 0.8, 0.4, 0.6)        # Green walls
const INVALID_FILL := Color(0.9, 0.2, 0.2, 0.2)      # Light red fill
const INVALID_BORDER := Color(0.9, 0.2, 0.2, 1.0)    # Red border
const INVALID_WALL := Color(0.9, 0.2, 0.2, 0.6)      # Red walls
const BLOCKED_FURNITURE := Color(1.0, 0.5, 0.0, 0.6) # Orange for blocked furniture

# State
var _controller: RoomResizeController = null
var _current_box: Rect2i = Rect2i()
var _is_valid: bool = false
var _blocked_furniture: Array[RoomInstance.FurniturePlacement] = []
```

**Setup method (called by Main.gd):**

```gdscript
func set_controller(controller: RoomResizeController) -> void:
    if _controller:
        # Disconnect old signals
        if _controller.preview_updated.is_connected(_on_preview_updated):
            _controller.preview_updated.disconnect(_on_preview_updated)
        if _controller.resize_cancelled.is_connected(_on_resize_cancelled):
            _controller.resize_cancelled.disconnect(_on_resize_cancelled)
        if _controller.resize_completed.is_connected(_on_resize_completed):
            _controller.resize_completed.disconnect(_on_resize_completed)

    _controller = controller

    if _controller:
        _controller.preview_updated.connect(_on_preview_updated)
        _controller.resize_cancelled.connect(_on_resize_cancelled)
        _controller.resize_completed.connect(_on_resize_completed)
```

**Signal handlers:**

```gdscript
func _on_preview_updated(new_box: Rect2i, validation: RefCounted) -> void:
    _current_box = new_box
    if validation:
        _is_valid = validation.is_valid
        _blocked_furniture = validation.blocked_furniture
    else:
        _is_valid = false
        _blocked_furniture = []
    queue_redraw()

func _on_resize_cancelled() -> void:
    _current_box = Rect2i()
    _blocked_furniture = []
    queue_redraw()

func _on_resize_completed(_room: RoomInstance) -> void:
    _current_box = Rect2i()
    _blocked_furniture = []
    queue_redraw()
```

**Drawing (_draw method):**

```gdscript
func _draw() -> void:
    if _controller == null or not _controller.is_active():
        return

    if _current_box.size == Vector2i.ZERO:
        return

    _draw_preview_box()
    _draw_blocked_furniture()

func _draw_preview_box() -> void:
    # Choose colors based on validity
    var fill_color: Color
    var wall_color: Color
    var border_color: Color
    if _is_valid:
        fill_color = VALID_FILL
        wall_color = VALID_WALL
        border_color = VALID_BORDER
    else:
        fill_color = INVALID_FILL
        wall_color = INVALID_WALL
        border_color = INVALID_BORDER

    var min_tile = _current_box.position
    var max_tile = _current_box.position + _current_box.size - Vector2i.ONE

    # Generate wall positions (same logic as WallOperation.generate_walls)
    var wall_positions: Array[Vector2i] = []
    for x in range(min_tile.x, max_tile.x + 1):
        wall_positions.append(Vector2i(x, min_tile.y))
        wall_positions.append(Vector2i(x, max_tile.y))
    for y in range(min_tile.y + 1, max_tile.y):
        wall_positions.append(Vector2i(min_tile.x, y))
        wall_positions.append(Vector2i(max_tile.x, y))

    # Draw interior tiles first (lighter color)
    for x in range(min_tile.x + 1, max_tile.x):
        for y in range(min_tile.y + 1, max_tile.y):
            RoomBuildDrawing.draw_tile_highlight(self, Vector2i(x, y), fill_color, get_viewport())

    # Draw wall tiles on top
    for wall_pos in wall_positions:
        RoomBuildDrawing.draw_tile_highlight(self, wall_pos, wall_color, get_viewport())

    # Draw outer border polyline
    var top = _tile_to_screen(min_tile)
    var right = _tile_to_screen(Vector2i(max_tile.x + 1, min_tile.y))
    var bottom = _tile_to_screen(Vector2i(max_tile.x + 1, max_tile.y + 1))
    var left = _tile_to_screen(Vector2i(min_tile.x, max_tile.y + 1))
    draw_polyline(PackedVector2Array([top, right, bottom, left, top]), border_color, 2.0)

func _draw_blocked_furniture() -> void:
    if _is_valid or _blocked_furniture.is_empty():
        return

    # Highlight blocked furniture tiles in orange
    for furn in _blocked_furniture:
        for tile in furn.get_occupied_tiles():
            RoomBuildDrawing.draw_tile_highlight(self, tile, BLOCKED_FURNITURE, get_viewport())
        # Also highlight access tiles
        for tile in furn.get_access_tiles():
            RoomBuildDrawing.draw_tile_highlight(self, tile, BLOCKED_FURNITURE.lightened(0.3), get_viewport())

func _tile_to_screen(tile_pos: Vector2i) -> Vector2:
    return IsometricMath.tile_to_screen(tile_pos, get_viewport())
```

**NOTE:** This class follows the same pattern as RoomBuildUI._draw_box_selection() for rendering, but gets its data from controller signals rather than internal state. The separation keeps the controller focused on logic and the highlight focused on visuals.
  </action>
  <verify>
File exists at scripts/room_editing/RoomResizeHighlight.gd and contains:
- class_name RoomResizeHighlight
- Color constants for valid/invalid/blocked states
- set_controller() method that connects to preview_updated, resize_cancelled, resize_completed signals
- _draw() method that renders preview box with interior, walls, and border
- _draw_blocked_furniture() method that highlights blocked furniture in orange
- Coordinate conversion via IsometricMath.tile_to_screen
  </verify>
  <done>
RoomResizeHighlight.gd created with:
- Valid/invalid color schemes (green/red)
- Blocked furniture highlighting (orange)
- Box preview rendering matching RoomBuildUI style
- Signal-based updates from controller
  </done>
</task>

</tasks>

<verification>
1. Read RoomResizeHighlight.gd and verify color constants
2. Verify set_controller() connects all required signals
3. Verify _draw_preview_box() renders interior, walls, and border
4. Verify _draw_blocked_furniture() highlights affected tiles
5. Verify it uses RoomBuildDrawing.draw_tile_highlight for consistency
</verification>

<success_criteria>
- RoomResizeHighlight.gd exists with complete preview rendering
- Colors match established UI patterns (green=valid, red=invalid)
- Blocked furniture is visually distinguished (orange)
- Rendering uses existing RoomBuildDrawing utilities
</success_criteria>

<output>
After completion, create `.planning/phases/08-room-resize/08-03-SUMMARY.md`
</output>
