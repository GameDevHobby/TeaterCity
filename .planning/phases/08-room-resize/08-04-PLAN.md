---
phase: 08-room-resize
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - scripts/room_editing/RoomEditMenu.gd
  - scripts/Main.gd
autonomous: true

must_haves:
  truths:
    - "Resize Room button appears in RoomEditMenu between Edit Room and room type action"
    - "Clicking Resize Room emits resize_room_pressed signal with room"
    - "Main.gd creates RoomResizeController and RoomResizeHighlight on startup"
    - "Main.gd enters resize mode when resize button pressed (disables camera, room selection)"
    - "After resize completes, Main.gd transitions to door edit mode for door re-placement"
    - "RoomManager Area2D is updated after resize to match new bounding box"
  artifacts:
    - path: "scripts/room_editing/RoomEditMenu.gd"
      provides: "Resize Room button and signal"
      exports: ["resize_room_pressed"]
    - path: "scripts/Main.gd"
      provides: "Resize controller wiring and mode transitions"
  key_links:
    - from: "scripts/room_editing/RoomEditMenu.gd"
      to: "scripts/Main.gd"
      via: "resize_room_pressed signal"
      pattern: "_room_edit_menu\\.resize_room_pressed\\.connect"
    - from: "scripts/Main.gd"
      to: "scripts/room_editing/RoomResizeController.gd"
      via: "enter_resize_mode call"
      pattern: "_resize_controller\\.enter_resize_mode"
    - from: "scripts/Main.gd"
      to: "scripts/room_editing/DoorEditController.gd"
      via: "door placement after resize"
      pattern: "_door_edit_controller\\.enter_edit_mode"
---

<objective>
Add Resize Room button to RoomEditMenu and wire RoomResizeController in Main.gd.

Purpose: Users need a way to initiate resize mode from the existing room edit menu. Main.gd orchestrates the resize workflow: entering resize mode, handling completion, transitioning to door placement, and updating the RoomManager's Area2D after the room bounds change.

Output: Updated RoomEditMenu.gd with resize button, updated Main.gd with resize controller integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-room-resize/08-RESEARCH.md

Key existing files:
- scripts/room_editing/RoomEditMenu.gd - add resize button
- scripts/Main.gd - wire resize controller (follow door edit controller pattern)
- scripts/RoomManager.gd - has unregister_room/register_room pattern for Area2D update
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Resize Room button to RoomEditMenu</name>
  <files>scripts/room_editing/RoomEditMenu.gd</files>
  <action>
Modify RoomEditMenu.gd to add a Resize Room button.

**1. Add new signal (after existing signals around line 9):**
```gdscript
signal resize_room_pressed(room: RoomInstance)
```

**2. Add new button variable (after _edit_room_btn around line 17):**
```gdscript
var _resize_room_btn: Button
```

**3. In _create_panel() method, add resize button AFTER _edit_room_btn creation and BEFORE _room_type_btn:**

Find this code block (around line 75-77):
```gdscript
_edit_room_btn = UIStyleHelper.create_styled_button("Edit Room", Vector2(160, 40))
_edit_room_btn.pressed.connect(_on_edit_room)
vbox.add_child(_edit_room_btn)
```

Add after it:
```gdscript
_resize_room_btn = UIStyleHelper.create_styled_button("Resize Room", Vector2(160, 40))
_resize_room_btn.pressed.connect(_on_resize_room)
vbox.add_child(_resize_room_btn)
```

**4. Add button handler method (after _on_edit_room around line 189):**
```gdscript
func _on_resize_room() -> void:
    if _current_room:
        resize_room_pressed.emit(_current_room)
```

The menu button order will now be:
1. Edit Furniture
2. Edit Room (doors)
3. Resize Room (NEW)
4. [Room Type Action]
5. --- separator ---
6. Delete Room
  </action>
  <verify>
Read scripts/room_editing/RoomEditMenu.gd and verify:
- resize_room_pressed signal is declared
- _resize_room_btn variable exists
- Button created with "Resize Room" text
- Button added to vbox between Edit Room and room type button
- _on_resize_room() handler emits signal with current room
  </verify>
  <done>
RoomEditMenu.gd updated with Resize Room button that emits resize_room_pressed signal
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire RoomResizeController and RoomResizeHighlight in Main.gd</name>
  <files>scripts/Main.gd</files>
  <action>
Modify Main.gd to create and wire the resize controller and highlight.

**1. Add new instance variables (after _deletion_op around line 22):**
```gdscript
var _resize_controller: RoomResizeController = null
var _resize_highlight: RoomResizeHighlight = null
```

**2. In _ready(), AFTER door edit setup (around line 145, after _door_edit_done_button.hide()), add resize setup:**

```gdscript
# Create resize editing CanvasLayer (same layer as room selection)
var resize_edit_layer = CanvasLayer.new()
resize_edit_layer.name = "ResizeEditLayer"
resize_edit_layer.layer = 0  # Same layer as SelectionHighlightLayer
add_child(resize_edit_layer)

# Create RoomResizeController
_resize_controller = RoomResizeController.new()
_resize_controller.name = "RoomResizeController"
_resize_controller.mouse_filter = Control.MOUSE_FILTER_IGNORE
_resize_controller.set_anchors_preset(Control.PRESET_FULL_RECT)
resize_edit_layer.add_child(_resize_controller)

# Create RoomResizeHighlight
_resize_highlight = RoomResizeHighlight.new()
_resize_highlight.name = "RoomResizeHighlight"
_resize_highlight.mouse_filter = Control.MOUSE_FILTER_IGNORE
_resize_highlight.set_anchors_preset(Control.PRESET_FULL_RECT)
resize_edit_layer.add_child(_resize_highlight)
_resize_highlight.set_controller(_resize_controller)

# Connect resize controller signals
_resize_controller.resize_completed.connect(_on_resize_completed)
_resize_controller.door_placement_needed.connect(_on_resize_door_placement_needed)
_resize_controller.mode_exited.connect(_on_resize_mode_exited)
```

**3. Connect RoomEditMenu resize signal (after delete_room_pressed.connect around line 67):**
```gdscript
_room_edit_menu.resize_room_pressed.connect(_on_resize_room_requested)
```

**4. Add handler for resize request (after _on_delete_room_requested around line 254):**
```gdscript
func _on_resize_room_requested(room: RoomInstance) -> void:
    print("Entering resize mode: ", room.id)

    # Hide room menu
    _room_edit_menu.hide()

    # Clear room selection
    _room_manager.clear_selection()

    # Disable room selection input during resize
    _room_manager.disable_selection()

    # Disable camera panning during resize
    camera.enable_pinch_pan = false

    # Pass exterior walls and tilemap to controller
    _resize_controller.set_exterior_walls(_exterior_walls)
    _resize_controller.set_wall_tilemap(room_build_manager.get_wall_tilemap_layer())

    # Enter resize mode
    _resize_controller.enter_resize_mode(room)
```

**5. Add handler for resize completed (after _on_resize_room_requested):**
```gdscript
func _on_resize_completed(room: RoomInstance) -> void:
    print("Resize completed: ", room.id)

    # Update RoomManager's Area2D to match new bounding box
    # Unregister and re-register to recreate the selection polygon
    _room_manager.unregister_room(room)
    _room_manager.register_room(room)

    # Notify navigation system of change
    Targets.notify_navigation_changed()
```

**6. Add handler for door placement needed (after _on_resize_completed):**
```gdscript
func _on_resize_door_placement_needed(room: RoomInstance) -> void:
    print("Resize requires door re-placement: ", room.id)

    # Pass exterior walls to door controller
    _door_edit_controller.set_exterior_walls(_exterior_walls)

    # Enter door edit mode (doors were cleared during resize)
    _door_edit_controller.enter_edit_mode(room)
    _door_edit_highlight.queue_redraw()

    # Show Done button
    _door_edit_done_button.show()
    _position_door_edit_button(room)
```

**7. Add handler for resize mode exited (after _on_resize_door_placement_needed):**
```gdscript
func _on_resize_mode_exited() -> void:
    print("Exited resize mode")
    camera.enable_pinch_pan = true
    _room_manager.enable_selection()
```

**IMPORTANT NOTE about Area2D update:** When room bounds change, the old Area2D collision polygon is wrong. The cleanest solution is to unregister (which queue_free's the Area2D) and re-register (which creates a new Area2D with correct polygon). This reuses existing RoomManager code rather than adding a new update method.

**IMPORTANT NOTE about workflow:** After resize completes:
1. resize_completed fires -> Main updates Area2D
2. door_placement_needed fires -> Main enters door edit mode
3. User places doors -> exits door edit mode
4. mode_exited fires -> Main re-enables camera/selection

The resize mode_exited is only called if user CANCELS resize. Successful resize transitions to door edit mode directly.
  </action>
  <verify>
Read scripts/Main.gd and verify:
- _resize_controller and _resize_highlight variables declared
- CanvasLayer created for resize editing
- Controller and highlight instantiated and added to layer
- Highlight's set_controller() called
- resize_room_pressed signal connected from menu
- _on_resize_room_requested handler enters resize mode
- _on_resize_completed handler updates Area2D and notifies navigation
- _on_resize_door_placement_needed handler enters door edit mode
- _on_resize_mode_exited handler re-enables camera/selection
  </verify>
  <done>
Main.gd updated with complete resize workflow:
- Controller/highlight creation
- Mode entry from menu
- Area2D update on completion
- Door placement transition after resize
- Proper cleanup on exit/cancel
  </done>
</task>

</tasks>

<verification>
1. Read RoomEditMenu.gd and verify resize button and signal
2. Read Main.gd and verify all resize handlers exist
3. Verify Area2D update uses unregister/register pattern
4. Verify door edit mode is entered after successful resize
5. Verify camera and selection are disabled during resize mode
</verification>

<success_criteria>
- Resize Room button appears in menu
- Clicking button enters resize mode (camera off, selection off)
- After successful resize, door edit mode is entered
- RoomManager Area2D is updated to match new bounds
- Cancel exits cleanly and re-enables camera/selection
</success_criteria>

<output>
After completion, create `.planning/phases/08-room-resize/08-04-SUMMARY.md`
</output>
