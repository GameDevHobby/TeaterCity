---
phase: 14-movie-scheduling-ui
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified:
  - scripts/room_editing/TheaterSchedulePanel.gd
  - scripts/Main.gd
autonomous: true

must_haves:
  truths:
    - "Tapping Theater Schedule opens a centered compact scheduling modal"
    - "Modal lists available movies with title, genre, rating, and duration"
    - "Confirming a selection invokes the scheduling API and closes the modal"
    - "Modal only closes through explicit controls (Cancel/X or Schedule)"
  artifacts:
    - path: "scripts/room_editing/TheaterSchedulePanel.gd"
      provides: "Theater movie scheduling modal UI"
      exports: ["TheaterSchedulePanel"]
      min_lines: 140
    - path: "scripts/Main.gd"
      provides: "Room-type button integration with theater schedule modal"
      contains: "_on_room_type_action_requested"
  key_links:
    - from: "scripts/room_editing/RoomEditMenu.gd"
      to: "scripts/Main.gd"
      via: "room_type_action_pressed signal"
      pattern: "room_type_action_pressed"
    - from: "scripts/Main.gd"
      to: "scripts/room_editing/TheaterSchedulePanel.gd"
      via: "signal wiring for confirm/cancel"
      pattern: "TheaterSchedulePanel"
---

<objective>
Implement the scheduling modal UX and connect theater room action button to movie selection and schedule confirmation.

Purpose: Deliver THTR-05 plus the user-facing half of THTR-06 with a compact, mobile-friendly scheduling flow.
Output: TheaterSchedulePanel UI component and Main.gd integration that opens, populates, confirms, and dismisses scheduling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-movie-scheduling-ui/14-CONTEXT.md
@.planning/phases/14-movie-scheduling-ui/14-RESEARCH.md
@scripts/room_editing/RoomEditMenu.gd
@scripts/room_editing/FurnitureListPanel.gd
@scripts/Main.gd
@scripts/utils/UIStyleHelper.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TheaterSchedulePanel compact modal component</name>
  <files>scripts/room_editing/TheaterSchedulePanel.gd</files>
  <action>
Create `TheaterSchedulePanel` as `class_name TheaterSchedulePanel extends Control` using existing UI style patterns (`UIStyleHelper`, `PanelContainer`, margins, styled buttons).

Implement a centered compact modal layout with:
- header/title,
- concise list preview with scroll,
- movie detail line(s) showing title/genre/rating/duration,
- primary `Schedule` button,
- explicit `Cancel` and/or close button.

Expose clear public methods to show/hide for a target room with movie list data (for example `show_for_room(room, movies)`), and emit typed signals for schedule confirmation and cancellation.

Enforce explicit-dismiss behavior: do not close on outside click/tap. Ensure no camera/input side effects are handled inside the panel; Main owns mode/input orchestration.
  </action>
  <verify>
Inspect `scripts/room_editing/TheaterSchedulePanel.gd` and confirm:
1. Modal root is full-rect Control with centered panel child.
2. Movie list entries display title/genre/rating/duration.
3. Only explicit controls emit close/confirm paths.
4. Public API exists for room + movie data injection.
  </verify>
  <done>
TheaterSchedulePanel exists as a reusable modal that can display movies, capture one selection, and emit explicit confirm/cancel signals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Theater Schedule button flow in Main</name>
  <files>scripts/Main.gd</files>
  <action>
Instantiate `TheaterSchedulePanel` in the existing UI layer setup (`_ready`) and connect panel signals to Main handlers.

Update `_on_room_type_action_requested(room)` behavior for theaters:
- replace direct `idle -> scheduled` transition behavior,
- open schedule panel with runtime movie pool data,
- keep non-theater room-type actions unchanged.

On panel confirm:
- call the scheduling API created in 14-01,
- close panel,
- restore any temporary input/camera state.

On panel cancel/close:
- close panel without room state changes.

Ensure multiple opens refresh from current pool state and preselect sensible default entry for quick mobile interaction.
  </action>
  <verify>
Run:
`godot --headless --path . --quit`

Then inspect flow in `scripts/Main.gd`:
1. Theater action opens modal instead of direct transition.
2. Confirm path routes through centralized scheduling API.
3. Cancel path leaves room state unchanged.
4. Non-theater room action path remains functional.
  </verify>
  <done>
Theater room-type button launches scheduling modal and confirmed selection schedules through guarded API, while cancel path is non-destructive.
  </done>
</task>

</tasks>

<verification>
1. Theater Schedule action no longer bypasses movie selection.
2. Modal is compact-centered and mobile-friendly with scrollable movie list.
3. Movie rows include title, genre, rating, and duration.
4. Confirm schedules and closes; cancel closes without scheduling.
5. Headless parse check succeeds.
</verification>

<success_criteria>
- [ ] `TheaterSchedulePanel` class created and wired to Main
- [ ] Theater action opens modal (not immediate scheduling)
- [ ] Movie metadata is visible in list
- [ ] Confirm triggers scheduling API and closes modal
- [ ] Modal supports explicit dismissal only
</success_criteria>

<output>
After completion, create `.planning/phases/14-movie-scheduling-ui/14-02-SUMMARY.md`
</output>
