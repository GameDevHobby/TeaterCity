---
phase: 14-movie-scheduling-ui
plan: 03
type: execute
wave: 3
depends_on: [14-01, 14-02]
files_modified:
  - test/unit/test_room_instance.gd
  - test/integration/test_theater_schedule_flow.gd
autonomous: false

must_haves:
  truths:
    - "Selected movie scheduling data survives save/load"
    - "Scheduling from UI path triggers idle -> scheduled with selected movie"
    - "Users can validate full scheduling flow in runtime"
  artifacts:
    - path: "test/unit/test_room_instance.gd"
      provides: "Unit coverage for theater schedule payload serialization"
      contains: "scheduled movie tests"
    - path: "test/integration/test_theater_schedule_flow.gd"
      provides: "Integration coverage for guarded schedule behavior"
      min_lines: 80
  key_links:
    - from: "test/integration/test_theater_schedule_flow.gd"
      to: "scripts/Main.gd"
      via: "schedule API invocation"
      pattern: "scheduled|state_machine"
---

<objective>
Prove scheduling behavior with automated tests and a single human verification checkpoint.

Purpose: Prevent regressions in persistence and scheduling transitions, and confirm UX behavior matches phase expectations.
Output: New/updated tests plus a runtime verification checkpoint for panel interaction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-movie-scheduling-ui/14-CONTEXT.md
@.planning/phases/14-movie-scheduling-ui/14-RESEARCH.md
@scripts/storage/RoomInstance.gd
@scripts/Main.gd
@test/unit/test_room_instance.gd
@test/integration/test_theater_state_resume.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for theater scheduled-movie room payload</name>
  <files>test/unit/test_room_instance.gd</files>
  <action>
Extend RoomInstance unit tests to validate schedule payload helpers and serialization:
- set/clear scheduled movie data methods,
- `to_dict` includes schedule payload when set,
- `from_dict` restores payload correctly,
- backward compatibility path (missing payload) falls back to safe defaults.

Add at least one signal assertion confirming `placement_changed` emits when scheduled movie data changes.
  </action>
  <verify>
Run:
`godot --headless --path . --script addons/gut/gut_cmdln.gd -gdir=test/unit -ginclude_subdirs -gexit`
  </verify>
  <done>
RoomInstance scheduled movie storage and serialization behavior is unit-tested, including compatibility and save-trigger signaling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test coverage for theater scheduling flow</name>
  <files>test/integration/test_theater_schedule_flow.gd</files>
  <action>
Create a focused integration test file covering schedule flow contracts:
- valid idle theater + valid movie selection sets room payload and transitions to `scheduled`,
- invalid selection (movie missing) does not transition,
- non-idle state does not re-schedule,
- non-theater room action path remains unaffected.

Follow existing integration test conventions and keep tests deterministic by creating in-memory room/movie objects directly where possible.
  </action>
  <verify>
Run:
`godot --headless --path . --script addons/gut/gut_cmdln.gd -gdir=test/integration -ginclude_subdirs -gexit`
  </verify>
  <done>
Integration tests protect the key schedule transition guardrails and selected-movie assignment behavior.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>End-to-end theater scheduling flow with modal UI, movie selection, and guarded state transition</what-built>
  <how-to-verify>
1. Run the game: `godot --path .`.
2. Select an existing theater room and tap `Theater Schedule`.
3. Confirm centered compact modal appears and shows movie rows with title/genre/rating/duration.
4. Tap `Cancel` and confirm theater state remains unchanged.
5. Reopen modal, select a movie, tap `Schedule`, and confirm theater state becomes `scheduled`.
6. Save and reload, then confirm selected movie data still exists on that theater room.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Unit tests pass for RoomInstance schedule payload behavior.
2. Integration tests pass for scheduling guards and transitions.
3. Runtime checklist confirms UI and behavior match phase success criteria.
</verification>

<success_criteria>
- [ ] Unit tests cover RoomInstance scheduled movie persistence and defaults
- [ ] Integration tests cover idle-only scheduling and invalid-path guards
- [ ] Human verification confirms modal UX and scheduling behavior
- [ ] No regression in theater state transitions
</success_criteria>

<output>
After completion, create `.planning/phases/14-movie-scheduling-ui/14-03-SUMMARY.md`
</output>
