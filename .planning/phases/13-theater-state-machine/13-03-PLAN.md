---
phase: 13-theater-state-machine
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/unit/test_theater_state_machine.gd
  - test/integration/test_theater_state_resume.gd
autonomous: true

must_haves:
  truths:
    - "Automated tests prove theater state graph and timed transition chain are correct"
    - "Automated tests prove theater state persistence/resume behavior is correct"
    - "Automated tests prove non-theater rooms are not forced into theater state wiring"
  artifacts:
    - path: "test/unit/test_theater_state_machine.gd"
      provides: "Unit tests for theater state config and transition chain"
      min_lines: 90
    - path: "test/integration/test_theater_state_resume.gd"
      provides: "Integration tests for save/load and resume progression"
      min_lines: 80
  key_links:
    - from: "test/unit/test_theater_state_machine.gd"
      to: "scripts/state_machine/TheaterStateConfig.gd"
      via: "state definition assertions"
      pattern: "TheaterStateConfig"
    - from: "test/integration/test_theater_state_resume.gd"
      to: "scripts/storage/RoomInstance.gd"
      via: "initialize_state_machine + to_dict/from_dict roundtrip"
      pattern: "initialize_state_machine|to_dict|from_dict"
---

<objective>
Add focused unit and integration tests that lock in theater state-machine behavior.

Purpose: Prevent regressions in THTR-01/THTR-02 by codifying state graph correctness, timer-driven transitions, and resume/persistence behavior.
Output: New unit/integration test suites that validate theater states across runtime and restore scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-theater-state-machine/13-RESEARCH.md
@.planning/phases/13-theater-state-machine/13-01-SUMMARY.md
@test/unit/test_room_state_machine.gd
@test/integration/test_timer_persistence.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for theater state graph and transition chain</name>
  <files>test/unit/test_theater_state_machine.gd</files>
  <action>
Create `test/unit/test_theater_state_machine.gd` following GUT patterns already used in `test_room_state_machine.gd`.

Cover at minimum:
1. TheaterStateConfig returns all five required states.
2. State definitions have correct `duration`/`next_state` wiring for `scheduled -> previews -> playing -> cleaning -> idle`.
3. Fresh theater initialization enters/starts in `idle`.
4. Timed progression from `scheduled` auto-advances through all timed states back to `idle` with simulated elapsed time.
5. Non-theater room type guard path does not auto-initialize theater states.

Use deterministic elapsed-time simulation by backdating timer start values (existing project pattern) rather than sleeping.
  </action>
  <verify>
Run:
`godot --headless --path . -s addons/gut/gut_cmdln.gd -gdir=res://test/unit -ginclude_subdirs -gtest=test_theater_state_machine.gd`
  </verify>
  <done>
Unit tests pass and verify the full theater state graph plus timer-driven transition behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for save/load and resume progression</name>
  <files>test/integration/test_theater_state_resume.gd</files>
  <action>
Create `test/integration/test_theater_state_resume.gd` to validate persistence + resume semantics for theater rooms.

Cover at minimum:
1. Theater room with active timed state serializes state machine payload in `RoomInstance.to_dict()`.
2. `RoomInstance.from_dict()` + `initialize_state_machine(theater_defs)` restores state and timer.
3. Simulated offline elapsed time fast-forwards across multiple transitions and lands in expected final state.
4. Recovery behavior remains safe when saved state payload is stale/invalid.

Keep tests focused on data/state behavior (not scene/UI rendering). Reuse existing integration-test style from `test_timer_persistence.gd`.
  </action>
  <verify>
Run:
`godot --headless --path . -s addons/gut/gut_cmdln.gd -gdir=res://test/integration -ginclude_subdirs -gtest=test_theater_state_resume.gd`
  </verify>
  <done>
Integration tests pass and demonstrate theater state persistence + resume correctness.
  </done>
</task>

</tasks>

<verification>
1. Unit test suite passes for theater state graph and transition chain.
2. Integration test suite passes for persistence/resume fast-forward behavior.
3. Tests run headless in CI-compatible command form.
</verification>

<success_criteria>
- [ ] `test/unit/test_theater_state_machine.gd` exists and passes
- [ ] `test/integration/test_theater_state_resume.gd` exists and passes
- [ ] Tests cover required theater states and transition order
- [ ] Tests cover save/load and offline fast-forward behavior
- [ ] Tests guard against regressions in non-theater room behavior
</success_criteria>

<output>
After completion, create `.planning/phases/13-theater-state-machine/13-03-SUMMARY.md`
</output>
