---
phase: 09-admin-menu-feature-flags
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - scripts/admin/AdminMenuUI.gd
  - scripts/admin/AdminMenu.gd
autonomous: false

must_haves:
  truths:
    - "Revert discards in-memory changes and restores saved state"
    - "Reset deletes all room data and save file with confirmation"
    - "Room visuals update correctly after revert/reset"
    - "Admin menu appears only in debug builds (or when explicitly enabled)"
  artifacts:
    - path: "scripts/admin/AdminMenuUI.gd"
      provides: "Working confirmation dialogs for revert and reset"
      contains: "ConfirmationDialog"
    - path: "scripts/admin/AdminMenu.gd"
      provides: "Visual cleanup signals after reset"
      contains: "rooms_reset"
  key_links:
    - from: "AdminMenu.reset_all_data"
      to: "Main.gd"
      via: "signal connection"
      pattern: "rooms_reset"
---

<objective>
Complete admin menu functionality with visual cleanup on reset and human verification.

Purpose: Ensure revert and reset operations work end-to-end, including proper visual cleanup when all rooms are deleted. This requires a signal from AdminMenu to Main.gd so visual cleanup can occur.

Output: Fully functional admin menu with confirmed revert/reset operations and proper room visual cleanup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-menu-feature-flags/09-RESEARCH.md

# Prior plan outputs
@.planning/phases/09-admin-menu-feature-flags/09-01-SUMMARY.md
@.planning/phases/09-admin-menu-feature-flags/09-02-SUMMARY.md

# Existing infrastructure
@scripts/admin/AdminMenu.gd
@scripts/admin/AdminMenuUI.gd
@scripts/Main.gd
@scripts/room_building/operations/DeletionOperation.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rooms_reset signal for visual cleanup</name>
  <files>scripts/admin/AdminMenu.gd</files>
  <action>
Update scripts/admin/AdminMenu.gd to emit a signal when reset completes so Main.gd can clean up room visuals.

Add signal at top of class:
```gdscript
signal rooms_reset
```

Update reset_all_data() to emit the signal after clearing rooms:
```gdscript
func reset_all_data() -> bool:
    # Get all rooms
    var rooms = _room_manager.get_all_rooms().duplicate()

    # Unregister each room (triggers room_removed signal for visual cleanup)
    for room in rooms:
        _room_manager.unregister_room(room)

    # Delete save file
    var success = RoomSerializer.delete_save_file()

    # Emit signal for any additional cleanup
    rooms_reset.emit()

    if success:
        print("AdminMenu: All data reset")
    else:
        push_error("AdminMenu: Failed to delete save file")

    return success
```

Note: RoomManager.unregister_room() already emits room_removed signal for each room, which Main.gd can listen to for visual cleanup. But rooms_reset provides a single signal after all rooms are cleared for any final cleanup.
  </action>
  <verify>
AdminMenu.gd contains:
- signal rooms_reset
- reset_all_data() emits rooms_reset after clearing rooms
  </verify>
  <done>
AdminMenu emits rooms_reset signal after reset operation completes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connect visual cleanup for reset in Main.gd</name>
  <files>scripts/Main.gd</files>
  <action>
Update scripts/Main.gd to connect to room_removed signal for visual cleanup during reset.

In _ready(), after the existing _room_manager signal connections, add:
```gdscript
# Connect to room_removed for cleanup when rooms are deleted (including admin reset)
_room_manager.room_removed.connect(_on_room_removed_for_cleanup)
```

Add the cleanup handler:
```gdscript
func _on_room_removed_for_cleanup(room: RoomInstance) -> void:
    # Clean up room visuals when a room is unregistered
    # This handles both single room deletion AND admin reset (which calls unregister_room for each)
    var wall_layer = room_build_manager.get_wall_tilemap_layer()

    # Delete furniture visuals
    _deletion_op.delete_furniture_visuals(room)

    # Delete door visuals
    if wall_layer:
        _deletion_op.delete_door_visuals(room, wall_layer)

    # Delete wall visuals (preserving shared walls and exterior)
    if wall_layer:
        _deletion_op.delete_wall_visuals(room, wall_layer, _room_manager, _exterior_walls)

    # Restore floor tiles
    if wall_layer:
        _deletion_op.restore_room_floor_tiles(room, wall_layer, _room_manager, _exterior_walls)
```

Also update _on_delete_room_requested() to NOT duplicate the deletion logic (since room_removed now handles it):
```gdscript
func _on_delete_room_requested(room: RoomInstance) -> void:
    print("Deleting room: ", room.id)

    # Unregister from RoomManager - this triggers room_removed which handles visual cleanup
    _room_manager.unregister_room(room)

    # Clear selection (menu already hidden by RoomEditMenu)
    _room_manager.clear_selection()

    # Notify patrons to recalculate paths (AFTER all changes complete)
    Targets.notify_navigation_changed()

    print("Room deleted: ", room.id)
```

This consolidates all deletion visual cleanup into the room_removed handler, making reset work correctly without duplicating code.
  </action>
  <verify>
Main.gd contains:
- _room_manager.room_removed.connect() in _ready()
- _on_room_removed_for_cleanup() handler
- _on_delete_room_requested() simplified to just unregister + notify navigation
  </verify>
  <done>
Visual cleanup happens automatically when any room is unregistered, supporting both single deletion and admin reset.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete admin menu with:
- Feature flag detection (debug builds or explicit setting)
- Hotkey toggle (tilde key ~)
- Revert to last save (with confirmation dialog)
- Reset all data (with confirmation dialog)
- Proper visual cleanup on reset
  </what-built>
  <how-to-verify>
1. Open project in Godot editor
2. Run the game (F5)
3. Build a room (press B, select room type, draw, place doors, place furniture, complete)
4. Press ~ (tilde) key - admin menu should appear centered on screen
5. Click "Close" - menu should hide
6. Press ~ again - menu should reappear
7. Click "Revert to Last Save" - confirmation dialog appears
8. Click "Cancel" in dialog - nothing happens, menu stays open
9. Click "Revert to Last Save" again, then "Revert" in dialog:
   - Room should stay (it was auto-saved)
   - Console shows "AdminMenu: Reverted to last save"
10. Build another room, but don't wait 5 seconds (auto-save delay)
11. Press ~ and click "Revert to Last Save", confirm:
    - New room should disappear (it wasn't saved yet)
    - Original room should remain
12. Press ~ and click "Reset All Data"
13. Confirmation dialog should say "DELETE ALL ROOM DATA?" with warning
14. Click "Delete All Data":
    - All rooms should disappear
    - Console shows "AdminMenu: All data reset"
15. Close and reopen the game:
    - No rooms should exist (save file was deleted)

Edge cases to verify:
- Admin menu should NOT appear in release export (would need to test export, optional)
- Multiple tilde presses toggle menu on/off correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Tilde key toggles admin menu on/off
2. Revert restores last saved state
3. Reset clears all rooms and deletes save file
4. Confirmation dialogs protect destructive actions
5. Visual cleanup occurs correctly (no orphaned tiles/sprites)
6. Admin menu only available when feature flag is enabled
</verification>

<success_criteria>
Phase 9 success criteria met:
1. Admin menu only appears when feature flag is enabled (debug builds by default)
2. Revert option restores last saved state (discards unsaved changes)
3. Reset option clears all room data (with confirmation)
4. Feature flag can be toggled without code changes (OS.has_feature("debug") or ProjectSetting)
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-menu-feature-flags/09-03-SUMMARY.md`
</output>
