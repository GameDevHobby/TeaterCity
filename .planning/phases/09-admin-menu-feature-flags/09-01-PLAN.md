---
phase: 09-admin-menu-feature-flags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/admin/AdminMenu.gd
  - project.godot
autonomous: true

must_haves:
  truths:
    - "Admin features only available in debug builds by default"
    - "Admin features can be enabled in release builds via ProjectSetting"
    - "AdminMenu singleton accessible globally as autoload"
  artifacts:
    - path: "scripts/admin/AdminMenu.gd"
      provides: "AdminMenu autoload singleton with feature flag checking"
      exports: ["is_admin_enabled", "toggle_menu", "revert_to_save", "reset_all_data"]
      min_lines: 80
    - path: "project.godot"
      provides: "Autoload registration for AdminMenu"
      contains: "AdminMenu="
  key_links:
    - from: "scripts/admin/AdminMenu.gd"
      to: "RoomManager"
      via: "get_node(/root/RoomManager)"
      pattern: "get_node.*RoomManager"
    - from: "scripts/admin/AdminMenu.gd"
      to: "RoomSerializer"
      via: "static method calls"
      pattern: "RoomSerializer\\.(load_rooms|delete_save_file)"
---

<objective>
Create AdminMenu autoload singleton with feature flag checking and save management operations.

Purpose: Provides global access to admin functionality (revert, reset) that is safely gated behind debug builds or explicit feature flags. This is the foundation for admin tools without any UI yet.

Output: AdminMenu.gd autoload singleton registered in project.godot, with feature detection and save management methods ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-menu-feature-flags/09-RESEARCH.md

# Existing infrastructure to integrate with
@scripts/RoomManager.gd
@scripts/storage/RoomSerializer.gd
@project.godot
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminMenu autoload singleton</name>
  <files>scripts/admin/AdminMenu.gd</files>
  <action>
Create scripts/admin/AdminMenu.gd as an autoload singleton following the existing RoomManager pattern.

The script should:
1. Extend Node (like RoomManager)
2. Implement `_is_admin_enabled()` that returns true if:
   - OS.has_feature("debug") is true (editor + debug exports), OR
   - ProjectSettings.has_setting("application/admin/enabled") AND that setting is true
3. Store `_is_enabled: bool` in _ready() by calling _is_admin_enabled()
4. Implement `is_admin_enabled() -> bool` public method that returns _is_enabled
5. Implement `revert_to_save() -> bool` that:
   - Gets all rooms from RoomManager.get_all_rooms().duplicate()
   - Unregisters each room via RoomManager.unregister_room()
   - Loads saved rooms via RoomSerializer.load_rooms()
   - Registers each loaded room via RoomManager.register_room()
   - Returns true on success
6. Implement `reset_all_data() -> bool` that:
   - Gets all rooms from RoomManager.get_all_rooms().duplicate()
   - Unregisters each room via RoomManager.unregister_room()
   - Deletes save file via RoomSerializer.delete_save_file()
   - Returns true on success
7. Use @onready var _room_manager: Node = get_node("/root/RoomManager") pattern for autoload reference

Add class_name AdminMenu at top. Include clear doc comments explaining feature flag behavior.

Note: Do NOT create UI in this task - that comes in Plan 02. This is operations-only.
  </action>
  <verify>
File exists at scripts/admin/AdminMenu.gd with:
- _is_admin_enabled() private method
- is_admin_enabled() public method
- revert_to_save() method
- reset_all_data() method
  </verify>
  <done>
AdminMenu.gd exists with feature flag detection and save management operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register AdminMenu as autoload in project.godot</name>
  <files>project.godot</files>
  <action>
Add AdminMenu to the [autoload] section of project.godot.

The entry should be:
```
AdminMenu="*res://scripts/admin/AdminMenu.gd"
```

Place it after RoomManager in the [autoload] section to ensure RoomManager initializes first (AdminMenu depends on RoomManager being available).

The asterisk (*) prefix is required for autoload registration in Godot 4.5.
  </action>
  <verify>
Run: grep "AdminMenu" project.godot
Should show: AdminMenu="*res://scripts/admin/AdminMenu.gd"
  </verify>
  <done>
AdminMenu registered as autoload singleton in project.godot, loading after RoomManager.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify feature flag detection works</name>
  <files>scripts/admin/AdminMenu.gd</files>
  <action>
Add a print statement in AdminMenu._ready() that logs the feature flag state:

```gdscript
func _ready() -> void:
    _is_enabled = _is_admin_enabled()
    if _is_enabled:
        print("AdminMenu: Enabled (debug build or admin flag set)")
    else:
        print("AdminMenu: Disabled (release build, no override)")
```

This provides runtime feedback for testing and debugging.
  </action>
  <verify>
Open project in Godot editor. Check Output panel shows:
"AdminMenu: Enabled (debug build or admin flag set)"

This confirms the autoload initializes correctly and feature flag detection works.
  </verify>
  <done>
AdminMenu initializes correctly and logs its enabled state. Feature flag detection working.
  </done>
</task>

</tasks>

<verification>
1. scripts/admin/AdminMenu.gd exists with all required methods
2. project.godot contains AdminMenu autoload entry
3. Running in Godot editor shows "AdminMenu: Enabled" in output
4. AdminMenu.is_admin_enabled() returns true when run in editor
</verification>

<success_criteria>
- AdminMenu autoload singleton created with feature flag detection
- revert_to_save() and reset_all_data() methods implemented
- AdminMenu registered in project.godot after RoomManager
- Feature flag check correctly returns true in debug builds
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-menu-feature-flags/09-01-SUMMARY.md`
</output>
