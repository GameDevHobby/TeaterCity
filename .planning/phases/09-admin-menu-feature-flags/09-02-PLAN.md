---
phase: 09-admin-menu-feature-flags
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - scripts/admin/AdminMenuUI.gd
  - scripts/Main.gd
autonomous: true

must_haves:
  truths:
    - "Admin menu UI appears when toggled via hotkey"
    - "Revert button triggers confirmation then reloads from save"
    - "Reset button triggers confirmation then deletes all data"
    - "Menu only appears when AdminMenu.is_admin_enabled() is true"
  artifacts:
    - path: "scripts/admin/AdminMenuUI.gd"
      provides: "Admin menu UI Control with revert/reset buttons"
      exports: ["revert_requested", "reset_requested"]
      min_lines: 100
    - path: "scripts/Main.gd"
      provides: "Hotkey toggle for admin menu"
      contains: "KEY_QUOTELEFT"
  key_links:
    - from: "scripts/admin/AdminMenuUI.gd"
      to: "AdminMenu"
      via: "get_node(/root/AdminMenu)"
      pattern: "get_node.*AdminMenu"
    - from: "scripts/Main.gd"
      to: "AdminMenu"
      via: "toggle_menu call"
      pattern: "AdminMenu\\.toggle_menu"
    - from: "scripts/admin/AdminMenuUI.gd"
      to: "ConfirmationDialog"
      via: "dialog creation"
      pattern: "ConfirmationDialog\\.new"
---

<objective>
Create AdminMenuUI with hotkey toggle, confirmation dialogs for destructive actions, and Main.gd integration.

Purpose: Provides the user interface for admin functionality - a modal panel with Revert and Reset buttons, each protected by ConfirmationDialog. The menu is toggled via tilde key (~) and only available when admin features are enabled.

Output: AdminMenuUI.gd Control class with styled buttons and confirmation flow, integrated into Main.gd via hotkey input.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-menu-feature-flags/09-RESEARCH.md

# Prior plan output
@.planning/phases/09-admin-menu-feature-flags/09-01-SUMMARY.md

# Existing infrastructure
@scripts/admin/AdminMenu.gd
@scripts/Main.gd
@scripts/utils/UIStyleHelper.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminMenuUI Control class</name>
  <files>scripts/admin/AdminMenuUI.gd</files>
  <action>
Create scripts/admin/AdminMenuUI.gd as a Control class for the admin menu UI.

Structure:
```
AdminMenuUI (Control) - anchors: center
  CanvasLayer (layer: 10, to ensure it's above all other UI)
    PanelContainer (auto-sized)
      MarginContainer (20px padding)
        VBoxContainer (gap: 16px)
          Label (text: "Admin Menu", centered)
          Button (text: "Revert to Last Save", unique_name: RevertButton)
          Button (text: "Reset All Data", unique_name: ResetButton)
          HSeparator
          Button (text: "Close", unique_name: CloseButton)
```

The script should:
1. Add class_name AdminMenuUI
2. Extend Control
3. Define signals: revert_requested, reset_requested
4. In _ready():
   - Build the UI hierarchy programmatically (following existing Main.gd patterns)
   - Use UIStyleHelper.apply_button_style() for all buttons
   - Use UIStyleHelper.apply_panel_style() for the panel
   - Connect button signals to handlers
   - Start hidden (hide())
5. Implement _on_revert_pressed() that shows ConfirmationDialog:
   - dialog_text: "Revert to last saved state?\n\nAll unsaved changes will be lost."
   - ok_button_text: "Revert"
   - Connect confirmed signal to _perform_revert()
6. Implement _perform_revert() that:
   - Calls AdminMenu.revert_to_save() (get AdminMenu via get_node("/root/AdminMenu"))
   - Prints result
   - Hides the admin menu
7. Implement _on_reset_pressed() that shows ConfirmationDialog:
   - dialog_text: "DELETE ALL ROOM DATA?\n\nThis will:\n- Remove all rooms\n- Delete save file\n- Cannot be undone"
   - ok_button_text: "Delete All Data"
   - Connect confirmed signal to _perform_reset()
8. Implement _perform_reset() that:
   - Calls AdminMenu.reset_all_data()
   - Prints result
   - Hides the admin menu
9. Implement _on_close_pressed() that calls hide()
10. Use @onready var _admin_menu: Node = get_node("/root/AdminMenu") for AdminMenu reference

Use the dangerous red color Color(0.7, 0.2, 0.2) for the Reset button base_color to indicate destructive action.

Note: The CanvasLayer inside the Control ensures the panel renders above all game content regardless of where AdminMenuUI is in the scene tree.
  </action>
  <verify>
File exists at scripts/admin/AdminMenuUI.gd with:
- CanvasLayer wrapping the panel
- Three buttons (Revert, Reset, Close)
- ConfirmationDialog usage for Revert and Reset
- UIStyleHelper integration
  </verify>
  <done>
AdminMenuUI.gd exists with complete UI hierarchy and confirmation dialog flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AdminMenuUI instantiation and toggle to AdminMenu</name>
  <files>scripts/admin/AdminMenu.gd</files>
  <action>
Update scripts/admin/AdminMenu.gd to add UI management methods.

Add these members:
```gdscript
var _ui_instance: Control = null
```

Add toggle_menu() method:
```gdscript
func toggle_menu() -> void:
    if not _is_enabled:
        return

    if _ui_instance == null:
        _create_ui()

    _ui_instance.visible = !_ui_instance.visible
```

Add _create_ui() method:
```gdscript
func _create_ui() -> void:
    _ui_instance = AdminMenuUI.new()
    _ui_instance.name = "AdminMenuUI"
    # Add to root so it persists across scene changes
    get_tree().root.add_child(_ui_instance)
    _ui_instance.hide()
```

This lazy instantiation pattern avoids creating UI resources until the admin menu is first opened, and adding to root ensures it persists.
  </action>
  <verify>
AdminMenu.gd contains toggle_menu() method and _create_ui() helper.
  </verify>
  <done>
AdminMenu can create and toggle the admin menu UI on demand.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add hotkey toggle in Main.gd</name>
  <files>scripts/Main.gd</files>
  <action>
Update scripts/Main.gd to add admin menu hotkey toggle.

Add autoload reference at top with other @onready vars:
```gdscript
@onready var _admin_menu: Node = get_node("/root/AdminMenu")
```

Update _unhandled_input() to handle tilde key (~):
```gdscript
func _unhandled_input(event: InputEvent) -> void:
    if event.is_action_pressed("toggle_build"):
        _on_build_button_pressed()

    # Admin menu toggle (tilde key ~)
    if event is InputEventKey and event.pressed and event.keycode == KEY_QUOTELEFT:
        if _admin_menu.is_admin_enabled():
            _admin_menu.toggle_menu()
            get_viewport().set_input_as_handled()
            return

    # Deselect room when tapping empty space (touch release not consumed by Area2D)
    if event is InputEventScreenTouch and not event.pressed:
        # If we get here, no room area consumed the event
        # Area2D.input_event fires BEFORE _unhandled_input
        if _room_manager.get_selected_room():
            _room_manager.clear_selection()
```

KEY_QUOTELEFT is Godot's constant for the backtick/tilde key (~ on US keyboards).

The is_admin_enabled() check prevents the hotkey from doing anything in release builds where admin is disabled.
  </action>
  <verify>
Main.gd contains:
- _admin_menu @onready reference
- KEY_QUOTELEFT handling in _unhandled_input()
- is_admin_enabled() check before toggle
  </verify>
  <done>
Tilde key toggles admin menu in Main.gd when admin features are enabled.
  </done>
</task>

</tasks>

<verification>
1. scripts/admin/AdminMenuUI.gd exists with complete UI
2. AdminMenu.gd has toggle_menu() and _create_ui() methods
3. Main.gd handles KEY_QUOTELEFT to toggle admin menu
4. Run game in editor, press ~ key, admin menu appears
5. Click "Close" button, menu hides
6. Press ~ again, menu reappears
</verification>

<success_criteria>
- AdminMenuUI displays centered panel with Revert, Reset, and Close buttons
- Tilde key (~) toggles admin menu visibility
- Admin menu only accessible when is_admin_enabled() returns true
- UI follows existing pixel-art styling via UIStyleHelper
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-menu-feature-flags/09-02-SUMMARY.md`
</output>
