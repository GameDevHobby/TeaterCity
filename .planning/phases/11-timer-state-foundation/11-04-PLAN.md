---
phase: 11-timer-state-foundation
plan: 04
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - Scripts/ui/ResumeNotificationUI.gd
  - Scripts/ui/ResumeNotificationUI.tscn
  - Scripts/RoomManager.gd
autonomous: true

must_haves:
  truths:
    - "Toast notification appears when app resumes with state transitions"
    - "Notification shows count of state transitions that occurred offline"
    - "Notification auto-dismisses after brief display"
    - "Notification does not appear if zero transitions occurred"
  artifacts:
    - path: "Scripts/ui/ResumeNotificationUI.gd"
      provides: "Toast notification for resume events"
      exports: ["ResumeNotificationUI"]
    - path: "Scripts/ui/ResumeNotificationUI.tscn"
      provides: "Scene for resume notification"
  key_links:
    - from: "Scripts/ui/ResumeNotificationUI.gd"
      to: "Scripts/RoomManager.gd"
      via: "room_states_recalculated signal"
      pattern: "room_states_recalculated"
---

<objective>
Create a toast notification UI that informs players of state transitions that occurred while the app was backgrounded or closed.

Purpose: Per CONTEXT.md, show a brief notification like "3 movies finished while you were away" when the app resumes and state transitions occurred. This phase creates the foundation notification - the actual message content (movies, earnings, etc.) will be enhanced in later phases when those systems exist.

Output: ResumeNotificationUI component that appears briefly when RoomManager.room_states_recalculated signal fires with count > 0.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-timer-state-foundation/11-CONTEXT.md
@.planning/phases/11-timer-state-foundation/11-02-SUMMARY.md
@Scripts/RoomManager.gd
@Scripts/utils/UIStyleHelper.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResumeNotificationUI component</name>
  <files>Scripts/ui/ResumeNotificationUI.gd, Scripts/ui/ResumeNotificationUI.tscn</files>
  <action>
Create a toast notification component that shows briefly when app resumes.

**ResumeNotificationUI.tscn** scene structure:
```
ResumeNotificationUI (CanvasLayer)
└── PanelContainer (PanelContainer)
    - anchors: top center
    - offset_top: 20
    └── MarginContainer (MarginContainer)
        - margin: 12px all sides
        └── MessageLabel (Label)
            - text: "X state changes while away"
            - horizontal_alignment: CENTER
```

Use CanvasLayer to ensure notification appears above game content.

**ResumeNotificationUI.gd**:
```gdscript
class_name ResumeNotificationUI
extends CanvasLayer

@onready var panel: PanelContainer = $PanelContainer
@onready var message_label: Label = $PanelContainer/MarginContainer/MessageLabel

const DISPLAY_DURATION := 3.0  # seconds
const FADE_DURATION := 0.5  # seconds

var _display_timer: float = 0.0
var _is_fading := false

func _ready() -> void:
    layer = 100  # Above game UI
    panel.visible = false
    _setup_style()

func _setup_style() -> void:
    # Style matching game aesthetic
    var style = StyleBoxFlat.new()
    style.bg_color = Color(0.15, 0.12, 0.2, 0.95)  # Dark purple
    style.border_color = Color(0.5, 0.45, 0.4, 1.0)  # Warm brown
    style.set_border_width_all(2)
    style.set_corner_radius_all(4)
    style.set_content_margin_all(0)
    panel.add_theme_stylebox_override("panel", style)

    # Label style
    message_label.add_theme_color_override("font_color", Color(0.95, 0.9, 0.85))
    message_label.add_theme_font_size_override("font_size", 16)

func show_notification(transition_count: int) -> void:
    if transition_count <= 0:
        return

    # Format message - generic for Phase 11, will be enhanced later
    if transition_count == 1:
        message_label.text = "1 state change while away"
    else:
        message_label.text = "%d state changes while away" % transition_count

    # Reset state
    panel.modulate.a = 1.0
    panel.visible = true
    _display_timer = DISPLAY_DURATION
    _is_fading = false

    # Position at top center
    await get_tree().process_frame  # Wait for layout
    var viewport_size = get_viewport().get_visible_rect().size
    panel.position.x = (viewport_size.x - panel.size.x) / 2.0
    panel.position.y = 20

func _process(delta: float) -> void:
    if not panel.visible:
        return

    if _display_timer > 0:
        _display_timer -= delta
        if _display_timer <= 0:
            _is_fading = true

    if _is_fading:
        panel.modulate.a -= delta / FADE_DURATION
        if panel.modulate.a <= 0:
            panel.visible = false
            _is_fading = false
```

The notification is generic ("X state changes") for Phase 11. Later phases can enhance this to show "X movies finished" or include earnings when those systems exist.
  </action>
  <verify>
Verify scene and script parse:
```bash
godot --headless --path . --quit 2>&1 | grep -i error
```
  </verify>
  <done>ResumeNotificationUI.gd and ResumeNotificationUI.tscn exist. Notification shows transition count, auto-fades after 3 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Wire notification to RoomManager signal</name>
  <files>Scripts/Main.gd or appropriate scene controller</files>
  <action>
The ResumeNotificationUI needs to be instantiated in the scene tree and connected to RoomManager.room_states_recalculated signal.

Option A: Add to Main.tscn/Main.gd (recommended - keeps it centralized)
Option B: Make ResumeNotificationUI an autoload

For Option A, add to Main.gd:
```gdscript
# At top of file
var _resume_notification: ResumeNotificationUI = null

# In _ready():
func _ready() -> void:
    # ... existing code ...

    # Set up resume notification
    _setup_resume_notification()

func _setup_resume_notification() -> void:
    _resume_notification = preload("res://Scripts/ui/ResumeNotificationUI.tscn").instantiate()
    add_child(_resume_notification)

    # Connect to RoomManager signal
    RoomManager.room_states_recalculated.connect(_on_room_states_recalculated)

func _on_room_states_recalculated(transition_count: int) -> void:
    if _resume_notification:
        _resume_notification.show_notification(transition_count)
```

Check Main.gd for existing structure and add appropriately. If Main.gd doesn't have a _ready() function or is structured differently, adapt the integration point.

Alternative: If the project uses a different pattern for global UI, follow that pattern instead.
  </action>
  <verify>
Run the game briefly and verify no errors on startup:
```bash
godot --headless --path . --quit 2>&1 | grep -i error
```
  </verify>
  <done>ResumeNotificationUI is instantiated in Main scene and connected to RoomManager.room_states_recalculated signal.</done>
</task>

</tasks>

<verification>
All phase checks for Plan 04:

1. ResumeNotificationUI.gd exists with show_notification(count) method
2. ResumeNotificationUI.tscn is valid scene with CanvasLayer root
3. Notification styled to match game aesthetic (dark purple, warm brown border)
4. Auto-fade after DISPLAY_DURATION (3 seconds)
5. No notification shown for count = 0
6. Main.gd connects to RoomManager.room_states_recalculated
7. No errors on game startup

Manual test (requires state machine setup from Phase 13):
- Background app
- Wait for timer to complete
- Resume app
- Notification should appear briefly showing transition count
</verification>

<success_criteria>
- ResumeNotificationUI component displays toast at top center
- Message shows "X state change(s) while away"
- Notification auto-dismisses with fade after 3 seconds
- Notification only appears when transition_count > 0
- Component is wired to RoomManager.room_states_recalculated signal
- Visual style matches game aesthetic (dark panel, warm border)
</success_criteria>

<output>
After completion, create `.planning/phases/11-timer-state-foundation/11-04-SUMMARY.md`
</output>
