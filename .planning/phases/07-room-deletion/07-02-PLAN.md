---
phase: 07-room-deletion
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/room_editing/RoomEditMenu.gd
  - scripts/Main.gd
autonomous: true

must_haves:
  truths:
    - "Delete Room button appears in room edit menu"
    - "Confirmation dialog prevents accidental deletion"
    - "Room deletion clears navigation before visuals"
    - "Room deletion preserves adjacent room walls"
    - "Auto-save triggers after deletion"
  artifacts:
    - path: "scripts/room_editing/RoomEditMenu.gd"
      provides: "Delete Room button and ConfirmationDialog"
      contains: "delete_room_pressed"
    - path: "scripts/Main.gd"
      provides: "Deletion sequence orchestration"
      contains: "_on_delete_room_requested"
  key_links:
    - from: "scripts/room_editing/RoomEditMenu.gd"
      to: "scripts/Main.gd"
      via: "delete_room_pressed signal"
      pattern: "delete_room_pressed\\.connect"
    - from: "scripts/Main.gd"
      to: "DeletionOperation"
      via: "delete visual methods"
      pattern: "_deletion_op\\.delete"
    - from: "scripts/Main.gd"
      to: "RoomManager"
      via: "unregister_room()"
      pattern: "_room_manager\\.unregister_room"
---

<objective>
Add Delete Room UI to RoomEditMenu and wire the deletion sequence in Main.gd.

Purpose: Complete the user-facing deletion flow. Players need a way to trigger deletion with confirmation (prevents accidents), and Main.gd must orchestrate the cleanup sequence in the correct order (navigation first, then visuals, then unregister).

Output: Complete room deletion feature - tap Delete Room, confirm, room is removed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-room-deletion/07-RESEARCH.md
@.planning/phases/07-room-deletion/07-01-SUMMARY.md

# Files to modify
@scripts/room_editing/RoomEditMenu.gd
@scripts/Main.gd

# Reference for patterns
@scripts/room_building/RoomBuildController.gd
@scripts/room_building/operations/DeletionOperation.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Delete Room button to RoomEditMenu</name>
  <files>scripts/room_editing/RoomEditMenu.gd</files>
  <action>
Modify RoomEditMenu.gd to add a Delete Room button with ConfirmationDialog:

1. Add new signal at top (near other signals):
   ```gdscript
   signal delete_room_pressed(room: RoomInstance)
   ```

2. Add new member variables (near other UI elements):
   ```gdscript
   var _delete_room_btn: Button
   var _delete_dialog: ConfirmationDialog = null
   var _room_to_delete: RoomInstance = null
   ```

3. In `_create_panel()`, after creating `_room_type_btn`, add the delete button:
   ```gdscript
   # Add separator before destructive action
   var separator = HSeparator.new()
   vbox.add_child(separator)

   _delete_room_btn = UIStyleHelper.create_styled_button("Delete Room", Vector2(160, 40))
   _delete_room_btn.pressed.connect(_on_delete_room_pressed)
   vbox.add_child(_delete_room_btn)
   ```

4. In `_ready()`, after `_create_panel()`, create the confirmation dialog:
   ```gdscript
   # Create confirmation dialog for delete action
   _delete_dialog = ConfirmationDialog.new()
   _delete_dialog.title = "Confirm Deletion"
   _delete_dialog.dialog_text = "Delete this room?\n\nAll furniture will be removed.\nThis cannot be undone."
   _delete_dialog.confirmed.connect(_on_delete_confirmed)
   add_child(_delete_dialog)
   ```

5. Add handler methods at the bottom of the class:
   ```gdscript
   func _on_delete_room_pressed() -> void:
       if _current_room == null:
           return
       _room_to_delete = _current_room
       _delete_dialog.popup_centered()


   func _on_delete_confirmed() -> void:
       if _room_to_delete:
           delete_room_pressed.emit(_room_to_delete)
           _room_to_delete = null
           # Hide menu (selection will be cleared by Main.gd after deletion)
           hide()
   ```

The button uses a separator to visually distinguish the destructive action from other options.
  </action>
  <verify>
Run `godot --headless --quit --path .` to verify script compiles.
Search for `signal delete_room_pressed` in the file.
Search for `_delete_dialog` in the file.
  </verify>
  <done>
RoomEditMenu.gd has Delete Room button that shows confirmation dialog and emits delete_room_pressed signal on confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire deletion sequence in Main.gd</name>
  <files>scripts/Main.gd</files>
  <action>
Modify Main.gd to handle the deletion flow:

1. Add member variable near other operation variables:
   ```gdscript
   var _deletion_op: DeletionOperation = null
   ```

2. In `_ready()`, after creating `_room_edit_menu`, instantiate the operation:
   ```gdscript
   _deletion_op = DeletionOperation.new()
   ```

3. In `_ready()`, after connecting other `_room_edit_menu` signals, connect the delete signal:
   ```gdscript
   _room_edit_menu.delete_room_pressed.connect(_on_delete_room_requested)
   ```

4. Add the deletion handler method (place after `_on_room_type_action_requested`):
   ```gdscript
   func _on_delete_room_requested(room: RoomInstance) -> void:
       print("Deleting room: ", room.id)

       # Get tilemap references
       var wall_layer = room_build_manager.get_wall_tilemap_layer()
       var ground_layer = room_build_manager.get_tilemap_layer()

       # CRITICAL: Cleanup sequence order matters for navigation safety
       # 1. Clear navigation FIRST (make area non-walkable immediately)
       var nav_op = NavigationOperation.new()
       nav_op.clear_room_navigation(room, wall_layer)

       # 2. Notify patrons to stop targeting this room
       Targets.notify_navigation_changed()

       # 3. Delete furniture visuals (calls cleanup_visual -> queue_free)
       _deletion_op.delete_furniture_visuals(room)

       # 4. Restore ground tiles where furniture was (for adjacent room access)
       if ground_layer:
           _deletion_op.restore_furniture_ground_tiles(room, ground_layer)

       # 5. Delete door visuals (erase door tiles)
       if wall_layer:
           _deletion_op.delete_door_visuals(room, wall_layer)

       # 6. Delete wall visuals (ONLY non-shared tiles)
       if wall_layer:
           _deletion_op.delete_wall_visuals(room, wall_layer, _room_manager)

       # 7. Unregister from RoomManager (cleans up Area2D, triggers auto-save)
       _room_manager.unregister_room(room)

       # 8. Clear selection (menu already hidden by RoomEditMenu)
       _room_manager.clear_selection()

       print("Room deleted: ", room.id)
   ```

The sequence follows research recommendations:
- Navigation cleared FIRST to prevent patrons from walking to deleted area
- Targets notified IMMEDIATELY after navigation clear
- Visuals cleaned up AFTER navigation is safe
- Unregister LAST to trigger auto-save with room removed
  </action>
  <verify>
Run `godot --headless --quit --path .` to verify script compiles.
Search for `_on_delete_room_requested` in the file.
Search for `_deletion_op` in the file.
  </verify>
  <done>
Main.gd handles delete_room_pressed signal and executes cleanup sequence in correct order: navigation -> targets -> furniture -> ground tiles -> doors -> walls -> unregister.
  </done>
</task>

</tasks>

<verification>
1. Both files compile without errors: `godot --headless --quit --path .`
2. RoomEditMenu.gd contains `signal delete_room_pressed`
3. RoomEditMenu.gd contains `ConfirmationDialog` creation
4. Main.gd contains `_on_delete_room_requested` handler
5. Main.gd creates `_deletion_op = DeletionOperation.new()`
6. Main.gd connects `delete_room_pressed` signal
7. Deletion sequence in Main.gd clears navigation before deleting visuals
</verification>

<success_criteria>
- Delete Room button appears in room edit menu (4th button)
- Confirmation dialog appears before deletion
- Deletion clears navigation first, then visuals
- Shared walls with adjacent rooms preserved
- Room unregistered and auto-save triggered
- All scripts compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-room-deletion/07-02-SUMMARY.md`
</output>
