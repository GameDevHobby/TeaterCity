---
phase: 10-testing-verification
plan: 08
type: execute
wave: 2
depends_on:
  - "10-02"
  - "10-05"
files_modified:
  - test/integration/test_room_deletion_flow.gd
  - test/integration/test_persistence_flow.gd
autonomous: true

must_haves:
  truths:
    - "Room deletion removes room from RoomManager"
    - "Deletion cleans up room data structures"
    - "Persistence flow saves rooms and reloads correctly"
    - "Auto-save triggers on room changes"
  artifacts:
    - path: "test/integration/test_room_deletion_flow.gd"
      provides: "Integration tests for room deletion workflow"
      min_lines: 60
    - path: "test/integration/test_persistence_flow.gd"
      provides: "Integration tests for save/load persistence workflow"
      min_lines: 60
  key_links:
    - from: "test/integration/test_room_deletion_flow.gd"
      to: "scripts/RoomManager.gd"
      via: "singleton access and method calls"
      pattern: "RoomManager\\.(unregister_room|get_all_rooms)"
    - from: "test/integration/test_persistence_flow.gd"
      to: "scripts/storage/RoomSerializer.gd"
      via: "static method calls"
      pattern: "RoomSerializer\\.(save_rooms|load_rooms)"
---

<objective>
Create integration tests for room deletion and persistence workflows.

Purpose: TEST-04 requires integration tests for edit workflows. This plan covers room deletion flow (unregister, cleanup) and the full persistence flow (create -> save -> quit -> reload -> verify).

Output: Two integration test files for deletion and persistence workflows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-testing-verification/10-RESEARCH.md

# Reference implementations
@scripts/RoomManager.gd
@scripts/storage/RoomSerializer.gd
@scripts/room_building/operations/DeletionOperation.gd

# Test patterns to follow
@test/integration/test_room_build_flow.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_room_deletion_flow.gd</name>
  <files>test/integration/test_room_deletion_flow.gd</files>
  <action>
Create integration test file for room deletion workflow.

NOTE: RoomManager is a singleton autoload. Be careful not to pollute global state between tests. Create and register test rooms, then unregister them in cleanup.

Test structure:
```gdscript
extends GutTest

## Integration tests for room deletion workflow
## Tests RoomManager unregistration and data cleanup

var _wall_op: WallOperation
var _deletion_op: DeletionOperation
var _test_rooms: Array[RoomInstance] = []

func before_each() -> void:
    _wall_op = WallOperation.new()
    _deletion_op = DeletionOperation.new()
    _test_rooms.clear()

func after_each() -> void:
    # Clean up any rooms we registered
    for room in _test_rooms:
        if RoomManager.get_all_rooms().has(room):
            RoomManager.unregister_room(room)
    _test_rooms.clear()
    _wall_op = null
    _deletion_op = null

func _create_and_register_room(id: String, box: Rect2i) -> RoomInstance:
    var room = RoomInstance.new(id, "lobby")
    room.bounding_box = box
    room.walls = _wall_op.generate_walls(box)
    room.add_door(Vector2i(box.position.x + 2, box.position.y), 0)
    RoomManager.register_room(room)
    _test_rooms.append(room)
    return room
```

Tests:
- `test_unregister_removes_from_manager()` - room no longer in get_all_rooms() after unregister
- `test_unregister_nonexistent_room()` - unregistering room not in manager doesn't crash
- `test_get_all_rooms_empty_after_unregister_all()` - all registered rooms removed
- `test_deletion_operation_clears_furniture()` - delete_furniture_visuals iterates room.furniture
- `test_shared_walls_preserved_on_delete()` - using get_deletable_walls with adjacent room

Note: Visual cleanup (delete_wall_visuals, etc.) requires TileMapLayer which we can't easily test in integration without full scene. Focus on data state changes.
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/integration/test_room_deletion_flow.gd`

All tests should pass.
  </verify>
  <done>
- Room deletion from RoomManager tested
- Unregister removes room from get_all_rooms()
- Edge cases handled (nonexistent room)
- Shared wall preservation logic tested
- Tests clean up registered rooms
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test_persistence_flow.gd</name>
  <files>test/integration/test_persistence_flow.gd</files>
  <action>
Create integration test file for persistence workflow.

Test structure:
```gdscript
extends GutTest

## Integration tests for persistence workflow
## Tests full save/load cycle simulating game session lifecycle

var _wall_op: WallOperation

func before_each() -> void:
    _wall_op = WallOperation.new()
    # Clean save state
    RoomSerializer.delete_save_file()
    # Clean any rooms from RoomManager (if we're using it)
    _cleanup_room_manager()

func after_each() -> void:
    RoomSerializer.delete_save_file()
    _cleanup_room_manager()
    _wall_op = null

func _cleanup_room_manager() -> void:
    var rooms = RoomManager.get_all_rooms().duplicate()
    for room in rooms:
        RoomManager.unregister_room(room)

func _create_test_room(id: String, box: Rect2i) -> RoomInstance:
    var room = RoomInstance.new(id, "lobby")
    room.bounding_box = box
    room.walls = _wall_op.generate_walls(box)
    room.add_door(Vector2i(box.position.x + 2, box.position.y), 0)
    return room
```

Tests for full persistence flow:
- `test_create_save_reload_flow()` - create rooms, save, clear, load, verify data matches
- `test_multiple_rooms_persist()` - multiple rooms all preserved through save/load
- `test_furniture_persists()` - room with furniture has furniture after reload
- `test_doors_persist()` - door positions preserved through save/load
- `test_room_manager_integration()` - register rooms, save from get_all_rooms(), reload into manager

Tests for auto-save trigger simulation:
- `test_placement_changed_can_trigger_save()` - verify room.placement_changed signal emits
- `test_save_after_modification()` - modify room, save, reload, verify modification persisted

Test for session lifecycle:
- `test_simulated_restart()` - full flow: create, save, "restart" (clear state), load, verify
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/integration/test_persistence_flow.gd`

All tests should pass.
  </verify>
  <done>
- Full persistence flow tested (create -> save -> load -> verify)
- Multiple rooms persist correctly
- Furniture and doors persist through save/load
- RoomManager integration tested
- Session lifecycle simulated
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Run deletion flow tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/integration/test_room_deletion_flow.gd

# Run persistence flow tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/integration/test_persistence_flow.gd

# Run all integration tests
godot --headless --script addons/gut/gut_cmdln.gd -gdir=res://test/integration/

# Verify test files exist
grep -c "func test_" test/integration/test_room_deletion_flow.gd
grep -c "func test_" test/integration/test_persistence_flow.gd
```
</verification>

<success_criteria>
1. test_room_deletion_flow.gd exists with 5+ test methods
2. test_persistence_flow.gd exists with 8+ test methods
3. All tests pass when run with GUT
4. Room deletion workflow verified
5. Full persistence cycle verified
6. Tests clean up global state (RoomManager, save files)
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-verification/10-08-SUMMARY.md`
</output>
