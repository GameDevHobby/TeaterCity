---
phase: 10-testing-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/test_resize_operation.gd
autonomous: true

must_haves:
  truths:
    - "ResizeOperation.validate_resize() rejects undersized rooms"
    - "ResizeOperation.validate_resize() rejects oversized rooms"
    - "ResizeOperation.validate_resize() rejects overlapping rooms"
    - "ResizeOperation.validate_resize() rejects resize that would block furniture"
    - "ResizeOperation.validate_resize() returns blocked furniture list"
    - "Valid resize operations pass validation"
  artifacts:
    - path: "test/unit/test_resize_operation.gd"
      provides: "Unit tests for ResizeOperation validation and result structures"
      min_lines: 100
  key_links:
    - from: "test/unit/test_resize_operation.gd"
      to: "scripts/room_building/operations/ResizeOperation.gd"
      via: "instantiation and method calls"
      pattern: "ResizeOperation\\.new\\(\\)|validate_resize"
---

<objective>
Create unit tests for ResizeOperation validation logic.

Purpose: TEST-01 requires unit tests for room editing operations. ResizeOperation is the most complex operation with size constraints, overlap detection, and furniture bounds validation. Tests ensure resize validation catches all invalid cases and provides detailed feedback.

Output: `test/unit/test_resize_operation.gd` with comprehensive validation tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-testing-verification/10-RESEARCH.md

# Reference implementation
@scripts/room_building/operations/ResizeOperation.gd

# Test patterns to follow
@test/unit/test_collision_operation.gd
@test/unit/test_door_operation.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_resize_operation.gd with validation tests</name>
  <files>test/unit/test_resize_operation.gd</files>
  <action>
Create unit test file following existing patterns from test_collision_operation.gd:

1. Class structure:
   - `extends GutTest`
   - Instance variables for `_resize_op: ResizeOperation`, `_wall_op: WallOperation`
   - `before_each()` creating fresh operation instances
   - `after_each()` nulling references
   - Helper `_create_room_with_walls(box: Rect2i) -> RoomInstance` following existing pattern
   - Helper `_create_furniture(id: String, size: Vector2i, access_offsets: Array[Vector2i]) -> FurnitureResource`

2. Size constraint validation tests:
   - `test_valid_resize_within_constraints()` - resize passes when new size within room type min/max
   - `test_invalid_resize_too_small()` - fails when below min_size (use lobby type: 4x4 min)
   - `test_invalid_resize_too_large()` - fails when above max_size
   - `test_swapped_orientation_valid()` - 4x6 and 6x4 both valid if room type allows
   - `test_result_error_contains_size_info()` - error message includes actual vs required sizes

3. Room overlap validation tests:
   - `test_valid_resize_no_overlap()` - passes when no other rooms in area
   - `test_invalid_resize_overlaps_other_room()` - fails when new bounds intersect another room
   - `test_result_contains_overlapped_room()` - result.overlapped_room is set on overlap failure

4. Furniture bounds validation tests:
   - `test_valid_resize_furniture_fits()` - passes when all furniture inside new bounds
   - `test_invalid_resize_furniture_outside()` - fails when furniture footprint outside new bounds
   - `test_invalid_resize_furniture_on_wall()` - fails when furniture would be on new walls
   - `test_invalid_resize_access_tiles_blocked()` - fails when access tiles outside or on wall
   - `test_result_blocked_furniture_list()` - blocked_furniture array populated correctly
   - `test_multiple_blocked_furniture()` - all blocked furniture items captured in list

5. Result structure tests:
   - `test_result_structure_valid()` - is_valid true, error empty, arrays empty on success
   - `test_result_structure_invalid()` - is_valid false, error non-empty on failure
   - `test_result_blocked_furniture_type()` - verify blocked_furniture is typed array

IMPORTANT: Create a mock room_manager object for get_all_rooms() method:
```gdscript
var _mock_room_manager: RefCounted

class MockRoomManager extends RefCounted:
    var rooms: Array[RoomInstance] = []
    func get_all_rooms() -> Array[RoomInstance]:
        return rooms

func before_each() -> void:
    _mock_room_manager = MockRoomManager.new()
```
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_resize_operation.gd`

All tests should pass. Expect 15+ tests covering validation paths.
  </verify>
  <done>
- ResizeOperation size constraint validation is tested (valid, too small, too large, swapped orientation)
- Room overlap detection is tested (no overlap, overlap, result.overlapped_room)
- Furniture bounds validation is tested (fits, outside, on wall, access blocked, multiple blocked)
- Result structure is validated (types, fields)
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Run resize operation tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_resize_operation.gd

# Verify test file exists and has expected structure
grep -c "func test_" test/unit/test_resize_operation.gd
# Should return 15+
```
</verification>

<success_criteria>
1. test_resize_operation.gd exists with 15+ test methods
2. All tests pass when run with GUT
3. Tests cover all three validation stages: size, overlap, furniture
4. Result structures validated for both valid and invalid cases
5. Mock room manager used for overlap tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-verification/10-01-SUMMARY.md`
</output>
