---
phase: 10-testing-verification
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/test_room_serializer.gd
autonomous: true

must_haves:
  truths:
    - "RoomSerializer.save_rooms() creates valid JSON file"
    - "RoomSerializer.load_rooms() returns rooms from saved file"
    - "Save and load round-trip preserves room data"
    - "has_save_file() returns correct state"
    - "delete_save_file() removes the file"
  artifacts:
    - path: "test/unit/test_room_serializer.gd"
      provides: "Unit tests for RoomSerializer save/load happy paths"
      min_lines: 80
  key_links:
    - from: "test/unit/test_room_serializer.gd"
      to: "scripts/storage/RoomSerializer.gd"
      via: "static method calls"
      pattern: "RoomSerializer\\.(save_rooms|load_rooms|has_save_file|delete_save_file)"
---

<objective>
Create unit tests for RoomSerializer happy path operations.

Purpose: TEST-03 requires unit tests for persistence layer. RoomSerializer handles save/load with atomic writes. Tests verify save, load, and round-trip data integrity using actual file I/O with cleanup.

Output: `test/unit/test_room_serializer.gd` with save/load tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-testing-verification/10-RESEARCH.md

# Reference implementation
@scripts/storage/RoomSerializer.gd
@scripts/storage/RoomInstance.gd

# Test patterns to follow
@test/unit/test_room_instance.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_room_serializer.gd with save/load tests</name>
  <files>test/unit/test_room_serializer.gd</files>
  <action>
Create unit test file. NOTE: RoomSerializer uses actual file I/O (user://saves/rooms.json). Tests must clean up after themselves.

Test structure:
```gdscript
extends GutTest

## Unit tests for RoomSerializer
## Tests save/load functionality with actual file I/O
## IMPORTANT: Tests use real user:// directory and clean up after each test

var _wall_op: WallOperation

func before_each() -> void:
    _wall_op = WallOperation.new()
    # Ensure clean state before each test
    RoomSerializer.delete_save_file()

func after_each() -> void:
    # Clean up after each test
    RoomSerializer.delete_save_file()
    _wall_op = null

func _create_test_room(id: String, box: Rect2i) -> RoomInstance:
    var room = RoomInstance.new(id, "lobby")
    room.bounding_box = box
    room.walls = _wall_op.generate_walls(box)
    room.add_door(Vector2i(box.position.x + 2, box.position.y), 0)  # North door
    return room
```

Tests for save_rooms():
- `test_save_empty_rooms()` - save empty array returns true
- `test_save_single_room()` - save one room returns true
- `test_save_multiple_rooms()` - save multiple rooms returns true
- `test_save_creates_file()` - has_save_file() true after save

Tests for load_rooms():
- `test_load_no_file()` - load with no file returns empty array
- `test_load_after_save()` - load returns rooms after save
- `test_load_room_count()` - loaded room count matches saved count

Tests for round-trip data integrity:
- `test_roundtrip_room_id()` - room.id preserved
- `test_roundtrip_room_type()` - room.room_type_id preserved
- `test_roundtrip_bounding_box()` - room.bounding_box preserved
- `test_roundtrip_walls()` - room.walls array preserved (size and positions)
- `test_roundtrip_doors()` - room.doors array preserved
- `test_roundtrip_multiple_rooms()` - all rooms preserved with correct data

Tests for has_save_file():
- `test_has_save_file_false_initially()` - false before any save
- `test_has_save_file_true_after_save()` - true after save

Tests for delete_save_file():
- `test_delete_nonexistent_returns_true()` - deleting nonexistent file returns true (no-op)
- `test_delete_existing_file()` - deleting existing file returns true, has_save_file false

Note: For furniture round-trip, we need a furniture resource. Use a simple approach:
```gdscript
func _create_test_furniture() -> FurnitureResource:
    var furn = FurnitureResource.new()
    furn.id = "test_chair"
    furn.size = Vector2i(1, 1)
    return furn
```
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_room_serializer.gd`

All tests should pass. Verify no leftover save files after tests.
  </verify>
  <done>
- RoomSerializer save operations tested (empty, single, multiple rooms)
- Load operations tested (no file, after save)
- Round-trip data integrity verified (id, type, bounding_box, walls, doors)
- has_save_file() and delete_save_file() tested
- Tests clean up after themselves
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Run room serializer tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_room_serializer.gd

# Verify no leftover save file
ls -la ~/.local/share/godot/app_userdata/*/saves/ 2>/dev/null || echo "Clean"

# Verify test file exists
grep -c "func test_" test/unit/test_room_serializer.gd
# Should return 15+
```
</verification>

<success_criteria>
1. test_room_serializer.gd exists with 15+ test methods
2. All tests pass when run with GUT
3. Save/load happy paths tested
4. Round-trip data integrity verified for all room properties
5. Tests clean up save files in before_each/after_each
6. No leftover files after test run
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-verification/10-05-SUMMARY.md`
</output>
