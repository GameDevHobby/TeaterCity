---
phase: 10-testing-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/test_deletion_operation.gd
autonomous: true

must_haves:
  truths:
    - "DeletionOperation.get_deletable_walls() excludes exterior walls"
    - "DeletionOperation.get_deletable_walls() excludes shared walls"
    - "DeletionOperation.get_deletable_walls() returns deletable walls"
    - "DeletionOperation.delete_furniture_visuals() calls cleanup on all furniture"
  artifacts:
    - path: "test/unit/test_deletion_operation.gd"
      provides: "Unit tests for DeletionOperation shared wall detection and cleanup"
      min_lines: 80
  key_links:
    - from: "test/unit/test_deletion_operation.gd"
      to: "scripts/room_building/operations/DeletionOperation.gd"
      via: "instantiation and method calls"
      pattern: "DeletionOperation\\.new\\(\\)|get_deletable_walls"
---

<objective>
Create unit tests for DeletionOperation logic.

Purpose: TEST-01 requires unit tests for room editing operations. DeletionOperation handles shared wall detection and visual cleanup sequences. Tests ensure walls are correctly classified as deletable, shared, or exterior.

Output: `test/unit/test_deletion_operation.gd` with shared wall detection and cleanup tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-testing-verification/10-RESEARCH.md

# Reference implementation
@scripts/room_building/operations/DeletionOperation.gd

# Test patterns to follow
@test/unit/test_collision_operation.gd
@test/unit/test_wall_operation.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_deletion_operation.gd with shared wall and cleanup tests</name>
  <files>test/unit/test_deletion_operation.gd</files>
  <action>
Create unit test file following existing patterns:

1. Class structure:
   - `extends GutTest`
   - Instance variables for `_deletion_op: DeletionOperation`, `_wall_op: WallOperation`
   - Helper `_create_room_with_walls(box: Rect2i) -> RoomInstance`
   - Mock room manager class for get_all_rooms()

2. get_deletable_walls() tests:
   - `test_all_walls_deletable_no_shared_no_exterior()` - room with no adjacent rooms or exterior walls returns all walls as deletable
   - `test_exterior_walls_excluded()` - walls in exterior_walls array are NOT in deletable result
   - `test_shared_walls_excluded()` - wall positions present in another room's walls array are excluded
   - `test_partial_shared_wall()` - only shared portions excluded, rest deletable
   - `test_mixed_exterior_and_shared()` - both exterior and shared walls excluded correctly
   - `test_empty_room_returns_empty()` - room with no walls returns empty array

3. Shared wall scenarios:
   - `test_adjacent_rooms_share_wall()` - two rooms sharing a wall edge excludes shared positions
   - `test_rooms_not_touching()` - two separate rooms have all walls deletable

4. Note: Visual deletion methods (delete_wall_visuals, delete_door_visuals, delete_furniture_visuals) require TileMapLayer which is difficult to test in unit tests. These are tested in integration tests instead. We can test delete_furniture_visuals by verifying it iterates furniture and calls cleanup.

5. Furniture cleanup test:
   - `test_delete_furniture_visuals_calls_cleanup()` - verify all furniture placements have cleanup_visual called
     - Create room with mock furniture placements that track cleanup calls
     - Call delete_furniture_visuals()
     - Assert each placement's cleanup was invoked

Mock room manager pattern:
```gdscript
class MockRoomManager extends RefCounted:
    var rooms: Array[RoomInstance] = []
    func get_all_rooms() -> Array[RoomInstance]:
        return rooms
    func add_room(room: RoomInstance) -> void:
        rooms.append(room)
```
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_deletion_operation.gd`

All tests should pass. Expect 10+ tests.
  </verify>
  <done>
- DeletionOperation get_deletable_walls() is tested for exterior wall exclusion
- Shared wall detection tested with adjacent rooms
- Partial shared walls tested (only shared portions excluded)
- Empty room edge case handled
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Run deletion operation tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_deletion_operation.gd

# Verify test file exists
grep -c "func test_" test/unit/test_deletion_operation.gd
# Should return 10+
```
</verification>

<success_criteria>
1. test_deletion_operation.gd exists with 10+ test methods
2. All tests pass when run with GUT
3. get_deletable_walls() tested for exterior exclusion, shared exclusion, and mixed scenarios
4. Mock room manager used for multi-room tests
5. Tests focus on data logic, not visual rendering
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-verification/10-02-SUMMARY.md`
</output>
