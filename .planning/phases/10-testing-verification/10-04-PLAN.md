---
phase: 10-testing-verification
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/test_furniture_operation.gd
autonomous: true

must_haves:
  truths:
    - "FurnitureOperation calculates furniture world position correctly"
    - "FurnitureOperation creates visual nodes with correct names"
    - "FurnitureOperation handles missing scene gracefully"
  artifacts:
    - path: "test/unit/test_furniture_operation.gd"
      provides: "Unit tests for FurnitureOperation visual creation logic"
      min_lines: 50
  key_links:
    - from: "test/unit/test_furniture_operation.gd"
      to: "scripts/room_building/operations/FurnitureOperation.gd"
      via: "instantiation and method calls"
      pattern: "FurnitureOperation\\.new\\(\\)|_calculate_furniture_position"
---

<objective>
Create unit tests for FurnitureOperation logic.

Purpose: TEST-02 requires unit tests for furniture management operations. FurnitureOperation creates furniture visuals and clears navigation tiles. Tests verify position calculation and naming without requiring scene dependencies.

Output: `test/unit/test_furniture_operation.gd` with visual creation logic tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-testing-verification/10-RESEARCH.md

# Reference implementation
@scripts/room_building/operations/FurnitureOperation.gd

# Test patterns to follow
@test/unit/test_collision_operation.gd
@test/unit/test_room_instance.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_furniture_operation.gd with visual logic tests</name>
  <files>test/unit/test_furniture_operation.gd</files>
  <action>
Create unit test file. NOTE: FurnitureOperation.create_furniture_visual() requires parent_node and optionally tilemap_layer. We can test with a minimal Node2D parent using add_child_autofree().

Test structure:
```gdscript
extends GutTest

var _furn_op: FurnitureOperation
var _parent_node: Node2D

func before_each() -> void:
    _furn_op = FurnitureOperation.new()
    _parent_node = Node2D.new()
    add_child_autofree(_parent_node)

func after_each() -> void:
    _furn_op = null
    # _parent_node cleaned up by autofree

func _create_furniture(id: String, size: Vector2i = Vector2i(1, 1)) -> FurnitureResource:
    var furn = FurnitureResource.new()
    furn.id = id
    furn.size = size
    return furn

func _create_placement(furn: FurnitureResource, pos: Vector2i, rot: int) -> RoomInstance.FurniturePlacement:
    var placement = RoomInstance.FurniturePlacement.new()
    placement.furniture = furn
    placement.position = pos
    placement.rotation = rot
    return placement
```

Tests:
- `test_can_instantiate()` - FurnitureOperation.new() works
- `test_create_visual_returns_node()` - create_furniture_visual() returns a Node2D
- `test_create_visual_adds_to_parent()` - visual is added as child of parent_node
- `test_visual_name_format()` - name follows "Furniture_{id}_{x}_{y}" pattern
- `test_visual_name_with_different_positions()` - verify name changes with position
- `test_placement_visual_node_set()` - placement.visual_node is set after creation
- `test_no_scene_creates_placeholder()` - furniture without scene still creates a node (placeholder)
- `test_placeholder_warning_logged()` - verify push_warning called for missing scene (use gut_p for capturing)

Position calculation tests (if _calculate_furniture_position is accessible):
- `test_position_uses_isometric_math()` - verify position calculation uses IsometricMath.tile_to_world_float

Edge case:
- `test_null_furniture_in_placement()` - placement with null furniture still creates node

Note: Do NOT test with actual furniture scenes since they may have complex dependencies. Focus on the placeholder/fallback path and naming logic.
  </action>
  <verify>
Run: `godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_furniture_operation.gd`

All tests should pass.
  </verify>
  <done>
- FurnitureOperation can be instantiated
- Visual creation returns Node2D added to parent
- Naming convention tested (Furniture_{id}_{x}_{y})
- placement.visual_node is set after creation
- Placeholder path tested for missing scene
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Run furniture operation tests
godot --headless --script addons/gut/gut_cmdln.gd -gtest=res://test/unit/test_furniture_operation.gd

# Verify test file exists
grep -c "func test_" test/unit/test_furniture_operation.gd
```
</verification>

<success_criteria>
1. test_furniture_operation.gd exists with 8+ test methods
2. All tests pass when run with GUT
3. Visual creation logic tested (returns node, adds to parent, sets visual_node)
4. Naming convention verified
5. Missing scene fallback tested
6. add_child_autofree used for proper cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-verification/10-04-SUMMARY.md`
</output>
