---
phase: 01-room-manager-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/RoomManager.gd
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mouse clicks on desktop trigger room selection"
    - "Touch events on mobile still work for selection"
    - "Tap vs drag discrimination works for both input types"
  artifacts:
    - path: "scripts/RoomManager.gd"
      provides: "Dual input handling for mouse and touch"
      contains: ["InputEventMouseButton", "InputEventScreenTouch"]
---

<objective>
Fix room selection to handle both desktop mouse clicks (InputEventMouseButton) and mobile touch events (InputEventScreenTouch).

Root cause: _on_area_input() only handles InputEventScreenTouch, ignoring desktop mouse clicks.

Output: Room selection works on both desktop and mobile.
</objective>

<context>
Debug session: .planning/debug/room-tap-selection.md
UAT gap: Test 2 - "nothing happens when tapping the room"

Pattern from existing codebase (box_drawing_state.gd, door_placement_state.gd):
```gdscript
if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT:
    if event.pressed:
        # handle press
    else:
        # handle release
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mouse click handling to RoomManager._on_area_input</name>
  <files>scripts/RoomManager.gd</files>
  <action>
Modify `_on_area_input()` to handle both InputEventScreenTouch AND InputEventMouseButton.

Replace the current implementation (lines 114-130) with:

```gdscript
func _on_area_input(_viewport: Node, event: InputEvent, _shape_idx: int, room: RoomInstance) -> void:
	# Handle mouse clicks (desktop)
	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT:
		if event.pressed:
			_touch_start_pos = event.position
			_touch_start_time = Time.get_ticks_msec()
		else:
			var distance := event.position.distance_to(_touch_start_pos)
			var duration := Time.get_ticks_msec() - _touch_start_time
			if distance < TAP_DISTANCE_THRESHOLD and duration < TAP_TIME_THRESHOLD:
				select_room(room)
		return

	# Handle touch events (mobile)
	if event is InputEventScreenTouch:
		if event.pressed:
			_touch_start_pos = event.position
			_touch_start_time = Time.get_ticks_msec()
		else:
			var distance := event.position.distance_to(_touch_start_pos)
			var duration := Time.get_ticks_msec() - _touch_start_time
			if distance < TAP_DISTANCE_THRESHOLD and duration < TAP_TIME_THRESHOLD:
				select_room(room)
```

This follows the exact pattern used in box_drawing_state.gd and door_placement_state.gd for handling both input types.
  </action>
  <verify>
Run the game with `godot --path .`
Build a room, then click on it with the mouse.
Should see "Room selected: room_X" in console and yellow highlight appear.
  </verify>
  <done>
Mouse clicks and touch events both trigger room selection.
  </done>
</task>

</tasks>

<verification>
1. Run the game on desktop
2. Build a room to completion
3. Click on the completed room with mouse
4. Verify: Console prints "Room selected: room_X"
5. Verify: Yellow highlight appears on room tiles
6. Click outside room - highlight should clear
7. Click-and-drag on room (>20px) - should NOT select (camera pan)
</verification>

<success_criteria>
1. Mouse clicks trigger room selection on desktop
2. Touch events still work on mobile (preserved)
3. Click-and-drag does not trigger selection (tap vs drag discrimination)
4. All skipped UAT tests (3-6) can now be validated
</success_criteria>

<output>
After completion, create `.planning/phases/01-room-manager-foundation/01-03-SUMMARY.md`
</output>
