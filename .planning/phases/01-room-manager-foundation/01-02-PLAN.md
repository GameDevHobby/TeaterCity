---
phase: 01-room-manager-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/room_building/RoomSelectionHighlight.gd
  - scripts/room_building/RoomBuildController.gd
  - scripts/Main.gd
autonomous: true

must_haves:
  truths:
    - "Selected room displays visible yellow tint highlight"
    - "Highlight updates when selection changes"
    - "Highlight clears when selection cleared"
    - "Completed rooms are automatically registered with RoomManager"
    - "Tapping outside any room deselects current selection"
  artifacts:
    - path: "scripts/room_building/RoomSelectionHighlight.gd"
      provides: "Visual highlight for selected room"
      min_lines: 30
    - path: "scripts/room_building/RoomBuildController.gd"
      provides: "Room registration on completion"
      contains: "RoomManager.register_room"
    - path: "scripts/Main.gd"
      provides: "Deselection on tap outside rooms"
      contains: "RoomManager.clear_selection"
  key_links:
    - from: "scripts/room_building/RoomSelectionHighlight.gd"
      to: "scripts/RoomManager.gd"
      via: "signal connections"
      pattern: "RoomManager\\.(room_selected|selection_cleared)\\.connect"
    - from: "scripts/room_building/RoomSelectionHighlight.gd"
      to: "scripts/room_building/ui/RoomBuildDrawing.gd"
      via: "static method call for tile highlighting"
      pattern: "RoomBuildDrawing\\.draw_tile_highlight"
    - from: "scripts/room_building/RoomBuildController.gd"
      to: "scripts/RoomManager.gd"
      via: "register_room call after room_completed"
      pattern: "RoomManager\\.register_room"
---

<objective>
Create visual selection highlight and integrate RoomManager with existing systems (room registration on build complete, deselection on tap outside).

Purpose: Complete the selection feature by adding visual feedback and wiring RoomManager into the existing build workflow.

Output: Fully functional room selection with visual highlight, automatic registration, and proper deselection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-room-manager-foundation/01-RESEARCH.md
@.planning/phases/01-room-manager-foundation/01-01-SUMMARY.md

# Files to modify
@scripts/room_building/RoomBuildController.gd
@scripts/Main.gd

# Existing patterns to follow
@scripts/room_building/ui/RoomBuildDrawing.gd
@scripts/room_building/RoomBuildUI.gd
@scripts/utils/IsometricMath.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoomSelectionHighlight visual component</name>
  <files>scripts/room_building/RoomSelectionHighlight.gd</files>
  <action>
Create `scripts/room_building/RoomSelectionHighlight.gd` as a Control that draws selection highlights:

1. Extend Control (not CanvasLayer - will be added as child of existing UI structure)
2. Use class_name RoomSelectionHighlight

3. Define highlight color constant:
   `const SELECTION_COLOR := Color(1.0, 0.9, 0.2, 0.3)` - semi-transparent yellow

4. In `_ready()`:
   - Connect to `RoomManager.room_selected.connect(_on_room_selected)`
   - Connect to `RoomManager.selection_cleared.connect(_on_selection_cleared)`

5. Signal handlers:
   - `_on_room_selected(_room: RoomInstance) -> void`: call `queue_redraw()`
   - `_on_selection_cleared() -> void`: call `queue_redraw()`

6. Override `_draw() -> void`:
   - Get selected room: `var room = RoomManager.get_selected_room()`
   - If room is null, return early
   - Get room's bounding_box
   - Loop through all tiles in bounding box (x from position.x to position.x + size.x, same for y)
   - For each tile, call `RoomBuildDrawing.draw_tile_highlight(self, Vector2i(x, y), SELECTION_COLOR, get_viewport())`

This follows the exact pattern used in RoomBuildUI._draw_furniture_placement_hints() for drawing tile highlights.

Note: The highlight draws ALL tiles in the room (walls + interior), not just interior. This provides clear visual feedback for the entire room bounds.
  </action>
  <verify>
Run `grep -n "RoomBuildDrawing.draw_tile_highlight" scripts/room_building/RoomSelectionHighlight.gd` - must exist.
Run `grep -n "RoomManager.room_selected" scripts/room_building/RoomSelectionHighlight.gd` - must show connection.
Open Godot editor, check script compiles without errors.
  </verify>
  <done>
RoomSelectionHighlight.gd exists, connects to RoomManager signals, and uses RoomBuildDrawing for tile highlights.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate RoomManager with RoomBuildController and Main</name>
  <files>scripts/room_building/RoomBuildController.gd, scripts/Main.gd</files>
  <action>
**Modify scripts/room_building/RoomBuildController.gd:**

In `_on_complete_pressed()`, after `room_completed.emit(current_room)` (around line 162), add:

```gdscript
# Register with RoomManager for selection/editing
RoomManager.register_room(current_room)
```

This ensures every completed room is automatically tracked by RoomManager.

**Modify scripts/Main.gd:**

1. Add to `_ready()` after existing connection:
```gdscript
# Connect to RoomManager selection signals for future menu handling
RoomManager.room_selected.connect(_on_room_selected)
```

2. Add new method to handle selection (placeholder for Phase 2 menu):
```gdscript
func _on_room_selected(room: RoomInstance) -> void:
	# Placeholder for Phase 2 - will show room menu here
	print("Room selected: ", room.id)
```

3. Add to `_unhandled_input()` to handle deselection when tapping outside rooms:
```gdscript
# Deselect room when tapping empty space (touch release not consumed by Area2D)
if event is InputEventScreenTouch and not event.pressed:
	# Small delay to ensure Area2D input_event fires first
	# If we get here, no room area consumed the event
	if RoomManager.get_selected_room():
		RoomManager.clear_selection()
```

Note: The deselection logic works because Area2D.input_event fires BEFORE _unhandled_input. If a room area handles the tap, it marks the event as handled. Only unhandled taps reach _unhandled_input.
  </action>
  <verify>
Run `grep -n "RoomManager.register_room" scripts/room_building/RoomBuildController.gd` - must exist.
Run `grep -n "RoomManager.clear_selection" scripts/Main.gd` - must exist.
Run `grep -n "room_selected.connect" scripts/Main.gd` - must exist.
Open Godot editor, verify no script errors.
  </verify>
  <done>
RoomBuildController registers rooms on completion. Main.gd handles selection signal and clears selection on tap outside.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add RoomSelectionHighlight to Main scene</name>
  <files>scenes/Main.tscn (or equivalent main scene)</files>
  <action>
The RoomSelectionHighlight Control needs to be added to the scene tree.

Option A - If Main.tscn is editable via code:
Add to Main.gd `_ready()`:
```gdscript
# Create selection highlight overlay
var selection_highlight = RoomSelectionHighlight.new()
selection_highlight.name = "SelectionHighlight"
selection_highlight.mouse_filter = Control.MOUSE_FILTER_IGNORE  # Don't block input
add_child(selection_highlight)
```

Option B - Add to Main.tscn in Godot editor:
1. Open Main.tscn
2. Add a Control node as child of Main (or the appropriate UI layer)
3. Attach scripts/room_building/RoomSelectionHighlight.gd
4. Set mouse_filter to MOUSE_FILTER_IGNORE

Choose Option A (code-based) for cleaner integration - keeps the highlight logic self-contained.

IMPORTANT: The Control must be added AFTER RoomBuildUI in scene tree order so highlights draw on top of game world but below UI panels.
  </action>
  <verify>
Run the game with `godot --path .`
Build a room (press B, select room type, draw box, place doors, place furniture, complete).
The room should now be registered with RoomManager (check print statement).
Tap the completed room - should see "Room selected: room_1" print.
Tap outside the room - selection should clear.
  </verify>
  <done>
RoomSelectionHighlight is instantiated in the scene, draws highlights for selected rooms, and the full selection flow works end-to-end.
  </done>
</task>

</tasks>

<verification>
## Full Integration Test

1. Start the game: `godot --path .`
2. Build a room:
   - Press B to enter build mode
   - Select a room type
   - Draw a room box
   - Place required doors
   - Place required furniture
   - Click Complete

3. Exit build mode (press B again or it auto-exits)

4. Test selection:
   - Tap inside the completed room -> room should highlight with yellow tint
   - Console should show "Room selected: room_X"

5. Test deselection:
   - Tap outside any room -> highlight should disappear
   - Console should NOT show repeated selection messages

6. Test tap vs drag:
   - Start a tap inside room but drag finger >20px before releasing -> should NOT select
   - Hold tap inside room for >300ms before releasing -> should NOT select (if not already selected, re-selects if quick release)

7. Build a second room, verify both can be selected (only one at a time highlighted)
</verification>

<success_criteria>
1. Completed rooms are automatically registered with RoomManager
2. Tapping a room displays yellow highlight on all tiles
3. Tapping outside any room clears selection
4. Highlight updates correctly when switching between rooms
5. Camera pan (drag) does not trigger selection
6. Selection state accessible via RoomManager.get_selected_room()
</success_criteria>

<output>
After completion, create `.planning/phases/01-room-manager-foundation/01-02-SUMMARY.md`
</output>
