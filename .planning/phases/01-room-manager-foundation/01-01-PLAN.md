---
phase: 01-room-manager-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/RoomManager.gd
  - project.godot
autonomous: true

must_haves:
  truths:
    - "RoomManager singleton is accessible globally via RoomManager.method()"
    - "Completed rooms can be registered with RoomManager"
    - "Tapping a room's area selects that room"
    - "Tap is distinguished from drag (20px/300ms thresholds)"
  artifacts:
    - path: "scripts/RoomManager.gd"
      provides: "Room tracking singleton with selection state"
      exports: ["register_room", "select_room", "clear_selection", "get_selected_room"]
    - path: "project.godot"
      provides: "RoomManager autoload registration"
      contains: "RoomManager="
  key_links:
    - from: "scripts/RoomManager.gd"
      to: "scripts/utils/IsometricMath.gd"
      via: "static method calls for coordinate conversion"
      pattern: "IsometricMath\\.tile_to_world"
    - from: "scripts/RoomManager.gd"
      to: "Area2D.input_event"
      via: "signal connection for tap detection"
      pattern: "input_event\\.connect"
---

<objective>
Create the RoomManager autoload singleton with room tracking, Area2D-based hit detection, and tap vs drag input handling.

Purpose: Establish the foundation for room selection - the singleton pattern follows existing Targets.gd architecture, Area2D collision provides precise isometric hit detection.

Output: Globally accessible RoomManager that can register rooms and detect taps on their areas.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-room-manager-foundation/01-RESEARCH.md

# Existing patterns to follow
@scripts/Targets.gd
@scripts/utils/IsometricMath.gd
@scripts/storage/RoomInstance.gd
@project.godot
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoomManager singleton with Area2D selection</name>
  <files>scripts/RoomManager.gd</files>
  <action>
Create `scripts/RoomManager.gd` following the Targets.gd singleton pattern:

1. Extend Node (same as Targets.gd)

2. Define signals:
   - `room_added(room: RoomInstance)` - emitted when room registered
   - `room_selected(room: RoomInstance)` - emitted when room selected
   - `selection_cleared` - emitted when selection cleared

3. Private state:
   - `_rooms: Array[RoomInstance] = []` - all registered rooms
   - `_selected_room: RoomInstance = null` - currently selected
   - `_selection_areas: Dictionary = {}` - room.id -> Area2D mapping

4. Tap detection state (per research):
   - `const TAP_DISTANCE_THRESHOLD := 20.0` - pixels
   - `const TAP_TIME_THRESHOLD := 300` - milliseconds
   - `_touch_start_pos: Vector2`
   - `_touch_start_time: int`

5. Public methods:
   - `register_room(room: RoomInstance) -> void` - adds room if not exists, creates Area2D, emits room_added
   - `get_all_rooms() -> Array[RoomInstance]`
   - `get_room_by_id(id: String) -> RoomInstance`
   - `select_room(room: RoomInstance) -> void` - sets _selected_room, emits room_selected
   - `clear_selection() -> void` - clears if selected, emits selection_cleared
   - `get_selected_room() -> RoomInstance`

6. Private methods:
   - `_create_selection_area(room: RoomInstance) -> void`:
     - Create Area2D with name "SelectionArea_{room.id}"
     - Set `input_pickable = true` (CRITICAL - default is false)
     - Create CollisionPolygon2D child with polygon from `_room_to_polygon(room)`
     - Connect `area.input_event` to `_on_area_input.bind(room)`
     - Add as child of RoomManager
     - Store in `_selection_areas[room.id]`

   - `_room_to_polygon(room: RoomInstance) -> PackedVector2Array`:
     - Get bounding_box from room
     - Calculate isometric diamond corners using IsometricMath.tile_to_world()
     - Return 4 points: top, right, bottom, left of the diamond
     - Top = tile_to_world(top_left)
     - Right = tile_to_world(Vector2i(bottom_right.x, top_left.y))
     - Bottom = tile_to_world(bottom_right)
     - Left = tile_to_world(Vector2i(top_left.x, bottom_right.y))

   - `_on_area_input(_viewport: Node, event: InputEvent, _shape_idx: int, room: RoomInstance) -> void`:
     - Only handle InputEventScreenTouch
     - On pressed: record `_touch_start_pos = event.position`, `_touch_start_time = Time.get_ticks_msec()`
     - On released: calculate distance and duration, if both under thresholds call `select_room(room)`

Use static typing throughout. Follow existing code conventions (snake_case private vars with underscore prefix).

**NOTE on Area2D input with PinchPanCamera:** The Area2D.input_event signal fires regardless of whether PinchPanCamera.enable_pinch_pan is true or false. The camera only consumes drag events after they exceed certain thresholds; Area2D.input_event fires for all InputEventScreenTouch events that hit the Area2D's collision shape. Our tap detection thresholds (20px distance, 300ms time) are intentionally below typical camera pan thresholds, ensuring taps register before being interpreted as drags.
  </action>
  <verify>
Open project in Godot editor (`godot --editor --path .`), check no script errors on RoomManager.gd.
Run `grep -n "class_name" scripts/RoomManager.gd` - should NOT have class_name (autoloads don't use it).
Run `grep -n "input_pickable = true" scripts/RoomManager.gd` - must exist.
  </verify>
  <done>
RoomManager.gd exists with all methods, signals, and Area2D creation logic. Script compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register RoomManager as autoload</name>
  <files>project.godot</files>
  <action>
Add RoomManager to the [autoload] section of project.godot:

1. Find the [autoload] section
2. Add line after existing Targets entry:
   `RoomManager="*res://scripts/RoomManager.gd"`

The asterisk prefix (*) makes it a singleton that auto-instantiates.

Ensure the entry is on its own line, follows the same format as Targets entry.
  </action>
  <verify>
Run `grep "RoomManager" project.godot` - should show the autoload line.
Open Godot editor, go to Project > Project Settings > Autoload - RoomManager should appear in list.
  </verify>
  <done>
RoomManager appears in project.godot [autoload] section and is accessible in Godot editor autoload list.
  </done>
</task>

</tasks>

<verification>
1. Open Godot editor: `godot --editor --path .`
2. Check Script Editor shows no errors for RoomManager.gd
3. Check Project Settings > Autoload shows RoomManager
4. Create a test scene with a button that calls:
   ```gdscript
   # Quick test in any script's _ready():
   print("RoomManager exists: ", RoomManager != null)
   print("Can access methods: ", RoomManager.has_method("register_room"))
   ```
</verification>

<success_criteria>
1. RoomManager.gd compiles without errors
2. RoomManager is registered as autoload in project.godot
3. RoomManager is globally accessible via `RoomManager.method_name()`
4. All required signals and methods are present
5. Area2D creation includes `input_pickable = true`
6. Isometric polygon uses IsometricMath.tile_to_world() for all corners
</success_criteria>

<output>
After completion, create `.planning/phases/01-room-manager-foundation/01-01-SUMMARY.md`
</output>
