---
phase: 05-furniture-editing-operations
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - scripts/room_editing/FurnitureSelectionHighlight.gd
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Ghost preview shows furniture outline at cursor position during drag"
    - "Valid placement shows green/cyan preview"
    - "Invalid placement shows red preview"
    - "Preview disappears when drag ends"
  artifacts:
    - path: "scripts/room_editing/FurnitureSelectionHighlight.gd"
      provides: "Drag preview rendering with valid/invalid colors"
      contains: "_draw_drag_preview"
  key_links:
    - from: "FurnitureSelectionHighlight._on_drag_preview"
      to: "FurnitureEditController.furniture_drag_preview"
      via: "signal connection"
      pattern: "furniture_drag_preview\\.connect"
---

<objective>
Add visual drag preview to FurnitureSelectionHighlight showing furniture ghost at cursor position.

Purpose: Provide clear visual feedback during drag operations so players know where furniture will land and whether placement is valid.

Output: FurnitureSelectionHighlight renders a ghost preview during drag with valid/invalid coloring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-furniture-editing-operations/05-01-PLAN.md
@scripts/room_editing/FurnitureSelectionHighlight.gd
@scripts/room_editing/FurnitureEditController.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drag preview state and colors</name>
  <files>scripts/room_editing/FurnitureSelectionHighlight.gd</files>
  <action>
Add drag preview state variables and colors to FurnitureSelectionHighlight:

1. Add color constants for drag preview (after existing SELECTION_COLOR/ACCESS_TILE_COLOR):
```gdscript
const DRAG_VALID_COLOR := Color(0.2, 0.8, 0.4, 0.5)  # Green for valid placement
const DRAG_INVALID_COLOR := Color(0.9, 0.2, 0.2, 0.5)  # Red for invalid placement
const DRAG_ACCESS_VALID_COLOR := Color(0.2, 0.8, 0.4, 0.25)  # Lighter green for access tiles
const DRAG_ACCESS_INVALID_COLOR := Color(0.9, 0.2, 0.2, 0.25)  # Lighter red for access tiles
```

2. Add drag preview state variables (after _controller):
```gdscript
# Drag preview state
var _is_dragging: bool = false
var _drag_preview_position: Vector2i = Vector2i.ZERO
var _drag_preview_valid: bool = false
```
  </action>
  <verify>
Run `grep -n "DRAG_VALID\|_is_dragging\|_drag_preview" scripts/room_editing/FurnitureSelectionHighlight.gd` shows new constants and variables.
  </verify>
  <done>FurnitureSelectionHighlight has drag preview state variables and color constants.</done>
</task>

<task type="auto">
  <name>Task 2: Connect to drag preview signals and implement _draw updates</name>
  <files>scripts/room_editing/FurnitureSelectionHighlight.gd</files>
  <action>
1. Update set_controller to connect drag preview signals (add after existing signal connections):
```gdscript
if _controller.furniture_drag_preview.is_connected(_on_drag_preview):
    _controller.furniture_drag_preview.disconnect(_on_drag_preview)
if _controller.furniture_drag_ended.is_connected(_on_drag_ended):
    _controller.furniture_drag_ended.disconnect(_on_drag_ended)

# Then in the new controller section:
_controller.furniture_drag_preview.connect(_on_drag_preview)
_controller.furniture_drag_ended.connect(_on_drag_ended)
```

2. Add signal handlers:
```gdscript
func _on_drag_preview(position: Vector2i, is_valid: bool) -> void:
    _is_dragging = true
    _drag_preview_position = position
    _drag_preview_valid = is_valid
    queue_redraw()


func _on_drag_ended() -> void:
    _is_dragging = false
    queue_redraw()
```

3. Update _draw() to show drag preview instead of selection highlight during drag:
```gdscript
func _draw() -> void:
    if _controller == null:
        return

    var furniture := _controller.get_selected_furniture()
    if furniture == null:
        return

    var viewport := get_viewport()

    # During drag, show preview at drag position
    if _is_dragging:
        _draw_drag_preview(furniture, viewport)
        return

    # Normal selection highlight when not dragging
    # Draw access tiles first (lighter color, shows where patrons stand)
    var access_tiles := furniture.get_access_tiles()
    for tile in access_tiles:
        RoomBuildDrawing.draw_tile_highlight(self, tile, ACCESS_TILE_COLOR, viewport)

    # Draw occupied tiles on top (main selection highlight)
    var occupied_tiles := furniture.get_occupied_tiles()
    for tile in occupied_tiles:
        RoomBuildDrawing.draw_tile_highlight(self, tile, SELECTION_COLOR, viewport)
```

4. Add the drag preview drawing method:
```gdscript
func _draw_drag_preview(furniture: RoomInstance.FurniturePlacement, viewport: Viewport) -> void:
    # Calculate tiles at preview position (not current furniture.position)
    var furn_resource := furniture.furniture
    if furn_resource == null:
        return

    # Get footprint tiles at preview position
    var preview_tiles := RotationHelper.get_footprint_tiles(
        _drag_preview_position,
        furn_resource.size,
        furniture.rotation
    )

    # Get access tiles at preview position
    var access_offsets := furn_resource.get_rotated_access_tiles(furniture.rotation)
    var preview_access_tiles: Array[Vector2i] = []
    for offset in access_offsets:
        preview_access_tiles.append(_drag_preview_position + offset)

    # Choose colors based on validity
    var tile_color: Color
    var access_color: Color
    if _drag_preview_valid:
        tile_color = DRAG_VALID_COLOR
        access_color = DRAG_ACCESS_VALID_COLOR
    else:
        tile_color = DRAG_INVALID_COLOR
        access_color = DRAG_ACCESS_INVALID_COLOR

    # Draw access tiles first
    for tile in preview_access_tiles:
        RoomBuildDrawing.draw_tile_highlight(self, tile, access_color, viewport)

    # Draw footprint tiles on top
    for tile in preview_tiles:
        RoomBuildDrawing.draw_tile_highlight(self, tile, tile_color, viewport)

    # Also draw original position faintly (ghost showing where it was)
    var original_tiles := furniture.get_occupied_tiles()
    for tile in original_tiles:
        RoomBuildDrawing.draw_tile_highlight(self, tile, Color(0.5, 0.5, 0.5, 0.2), viewport)
```
  </action>
  <verify>
Run the game, enter furniture edit mode, select furniture, and drag it:
1. During drag, preview shows at cursor position (not original position)
2. Valid positions show green/cyan preview
3. Invalid positions (walls, outside room, overlapping) show red preview
4. Original position shows faint gray ghost
5. After release, preview disappears and selection highlight returns to normal
  </verify>
  <done>FurnitureSelectionHighlight shows drag preview with valid/invalid colors during furniture drag operations.</done>
</task>

</tasks>

<verification>
1. FurnitureSelectionHighlight connects to furniture_drag_preview and furniture_drag_ended signals
2. _draw() shows drag preview during drag, normal highlight otherwise
3. Valid placement shows green preview
4. Invalid placement shows red preview
5. Original position shows faint ghost during drag
</verification>

<success_criteria>
1. Dragging furniture shows visual preview at cursor position
2. Preview color indicates valid (green) or invalid (red) placement
3. Original position visible as faint ghost during drag
4. Preview disappears on drag end, normal highlight resumes
</success_criteria>

<output>
After completion, create `.planning/phases/05-furniture-editing-operations/05-02-SUMMARY.md`
</output>
